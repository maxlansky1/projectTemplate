name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
      - '**'  # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –≤–µ—Ç–æ–∫

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write

    steps:
      - name: üìÅ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3

      - name: ‚òï –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java –∏ Graphviz (–Ω—É–∂–Ω–∞ –¥–ª—è PlantUML)
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre graphviz

      - name: üåø –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é PlantUML, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É Graphviz –∏ Dot
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è PlantUML –≤ /usr/local/bin, —Å–∫–∞—á–∏–≤–∞–µ–º PlantUML
          sudo mkdir -p /usr/local/bin/plantuml
          sudo wget -q https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar -O /usr/local/bin/plantuml/plantuml.jar
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é PlantUML, Graphviz, Dot
          java -jar /usr/local/bin/plantuml/plantuml.jar -version
          dot -V
          java -jar /usr/local/bin/plantuml/plantuml.jar -testdot

      - name: üêç –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install sphinxcontrib-plantuml sphinx-rtd-theme

      - name: üìÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Sphinx
        run: |
          echo "–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è conf.py:"
          cat docs/conf.py

      - name: üìä –°–æ–±–∏—Ä–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
        env:
          PLANTUML_JAR_PATH: /usr/local/bin/plantuml/plantuml.jar
        run: |
          cd docs
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –±–∏–ª–¥
          make clean

          # –ü–µ—Ä–µ–¥–∞—ë–º –ø—É—Ç—å –∫ plantuml —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∞ –Ω–µ –ø—Ä–∞–≤–∏–º conf.py
          make html SPHINXOPTS="-D plantuml=java\ -jar\ $PLANTUML_JAR_PATH"

          # –î–æ–±–∞–≤–ª—è–µ–º .nojekyll —á—Ç–æ–±—ã GitHub Pages –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª —Ñ–∞–π–ª—ã –∫–∞–∫ Jekyll-—Å–∞–π—Ç
          touch _build/html/.nojekyll

      - name: üñºÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–±—Ä–∞–Ω –ª–∏ HTML
        run: |
          ls -la docs/_build/html/

      - name: üöÄ –î–µ–ø–ª–æ–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –Ω–∞ GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build/html