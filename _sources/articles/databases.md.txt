# üóÑÔ∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SQL

#TODO: —É–ª—É—á—à–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã C4

–í —à–∞–±–ª–æ–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ **SQLAlchemy 2.0+**.  
–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ **SQLite**, –Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ –¥—Ä—É–≥–∏–µ –ë–î.

SQLite ‚Äî —ç—Ç–æ **–≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è** —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞**.  
–û–Ω–∞ **—Ö—Ä–∞–Ω–∏—Ç –≤—Å—é –±–∞–∑—É –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ**, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ—ë **–∏–¥–µ–∞–ª—å–Ω–æ–π –¥–ª—è**:

- **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏—è** ‚Äî –±—ã—Å—Ç—Ä–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, **–Ω–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å** —Å–µ—Ä–≤–µ—Ä –ë–î.
- **–ù–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤** ‚Äî –≥–¥–µ **–Ω–µ –Ω—É–∂–Ω–∞ –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞** –∏–ª–∏ **–º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –¥–æ—Å—Ç—É–ø**.
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** ‚Äî –ª–µ–≥–∫–æ –æ—á–∏—â–∞—Ç—å, —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å, –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ.
- **–õ–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞** ‚Äî **–Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å**, –∫—Ä–æ–º–µ Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

```{admonition} –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ
:class: warning 
–î–ª—è **–ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞** –∏ **—Å–µ—Ä—å—ë–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤** —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **PostgreSQL** –∏–ª–∏ –¥—Ä—É–≥—É—é **—Å–µ—Ä–≤–µ—Ä–Ω—É—é –°–£–ë–î**, –ø–æ—Ç–æ–º—É —á—Ç–æ:

- SQLite **–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç** –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—É—é –∑–∞–ø–∏—Å—å.
- –£ –Ω–µ—ë **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** –ø–æ **–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** –∏ **–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏**.
- –ù–µ—Ç **–≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏** —Å–ª–æ–∂–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `JSON`, `ENUM`).

–ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ SQLite –º–æ–∂–Ω–æ [–ø–æ—á–∏—Ç–∞—Ç—å –Ω–∞ –•–∞–±—Ä–µ](https://habr.com/ru/articles/547448/)
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQLite

```text
.
‚îú‚îÄ‚îÄ alembic/
‚îÇ   ‚îú‚îÄ‚îÄ env.py                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ versions/              # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ configs/
‚îÇ   ‚îú‚îÄ‚îÄ settings.py            # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (AppSettings)
‚îÇ   ‚îî‚îÄ‚îÄ schemas/
‚îÇ       ‚îî‚îÄ‚îÄ database.py        # Pydantic-—Å—Ö–µ–º—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ databases/
‚îÇ       ‚îú‚îÄ‚îÄ dao/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ base.py        # –ë–∞–∑–æ–≤—ã–π DAO
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ user_dao.py    # DAO –¥–ª—è –º–æ–¥–µ–ª–∏ User
‚îÇ       ‚îî‚îÄ‚îÄ sqlite/
‚îÇ           ‚îú‚îÄ‚îÄ core.py        # –î–≤–∏–∂–æ–∫, —Å–µ—Å—Å–∏—è, –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä @connection
‚îÇ           ‚îú‚îÄ‚îÄ connection.py  # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏ –¥–ª—è FastAPI
‚îÇ           ‚îú‚îÄ‚îÄ models/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ base.py    # Declarative Base
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ user.py    # ORM-–º–æ–¥–µ–ª—å User
‚îÇ           ‚îî‚îÄ‚îÄ schemas/
‚îÇ               ‚îî‚îÄ‚îÄ user.py    # Pydantic-—Å—Ö–µ–º—ã –¥–ª—è User
```

```{eval-rst}
.. uml:: ../../projectTemplate/diagrams/database_schema.puml
   :scale: 50 %
   :align: center
```

–í —à–∞–±–ª–æ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                             |
| :--------------- | :------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------- |
| **[Pydantic](https://docs.pydantic.dev/)**     | **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**                                                   | –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.                           |
| **[SQLAlchemy](https://www.sqlalchemy.org/)**   | **ORM-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞**                                                         | –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ** —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ **Python-–æ–±—ä–µ–∫—Ç—ã**. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä `aiosqlite`.     |
| **[Alembic](https://alembic.sqlalchemy.org/)**      | **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–π**                                                    | –ü–æ–∑–≤–æ–ª—è–µ—Ç **—É–ø—Ä–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**.                                                      |
| **DAO-–ø–∞—Ç—Ç–µ—Ä–Ω**  | **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥**                                                   | **–£–ø—Ä–æ—â–∞–µ—Ç** —Ä–∞–±–æ—Ç—É —Å –º–æ–¥–µ–ª—è–º–∏ –∏ **—Å–∫—Ä—ã–≤–∞–µ—Ç** –¥–µ—Ç–∞–ª–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î.                                   |

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –º–æ–¥—É–ª–µ configs/schemas/database.py, –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç —Å—Ö–µ–º—É Pydantic –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î. –ö–ª–∞—Å—Å `SQLiteSettings` –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ SQLite.
–ö–ª–∞—Å—Å `DatabaseSettings` –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ –≤—Å–µ–º –ë–î. 

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../configs/schemas/database.py
      :language: python
      :caption: configs/schemas/database.py
```

`DatabaseSettings` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `AppSettings` –≤ `configs/settings.py`:

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../configs/settings.py
      :language: python
      :caption: configs/settings.py
```


````{admonition} –û–±–Ω–æ–≤–∏—Ç–µ .env —Ñ–∞–π–ª
:class: warning
–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª .env –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —É–∫–∞–∂–∏—Ç–µ –≤ –Ω—ë–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

–ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏–π –≤ `.env` —Ñ–∞–π–ª–µ:

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SQLite
SQLITE_DATABASE_URL=sqlite+aiosqlite:///./data/db.sqlite3  # URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ SQLite (aiosqlite ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫)
SQLITE_ECHO=false                                         # –í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ (true/false)
SQLITE_POOL_PRE_PING=true                                 # –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è true)
SQLITE_EXPIRE_ON_COMMIT=false                             # –ù–µ —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç –æ–±—ä–µ–∫—Ç—ã –ø–æ—Å–ª–µ commit (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è false –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏)
SQLITE_AUTOFLUSH=false                                    # –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π flush (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è false –ø—Ä–∏ —Ä—É—á–Ω–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–µ–π)
SQLITE_POOL_SIZE=5                                        # –†–∞–∑–º–µ—Ä –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
SQLITE_MAX_OVERFLOW=10                                    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å–≤–µ—Ä—Ö –ø—É–ª–∞
```
````

```{admonition} –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è –ë–î
:class: tip

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ë–î —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ –ø—É—Ç–∏ /data/db.sqlite3
–ü–∞–ø–∫–∞ `data/` —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.  
–≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `configs/settings.py` –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `AppSettings`.

–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å **–∫–∞—Å—Ç–æ–º–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**, –∏–∑–º–µ–Ω–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `SQLITE_DATABASE_URL` –≤ `.env` —Ñ–∞–π–ª–µ.

–ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–¥–∏–º –ë–î my_database.sqlite3
```bash
SQLITE_DATABASE_URL=sqlite+aiosqlite:///./data/my_database.sqlite3
```

## üß© SQLAlchemy

SQLAlchemy ‚Äî —ç—Ç–æ –º–æ—â–Ω–∞—è **ORM-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞** –¥–ª—è Python. –û–Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–∏–±–∫–∏–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∑–≤–æ–ª—è—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥** –≤–º–µ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—è "–≥–æ–ª–æ–≥–æ" SQL, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:

- **–¢–∞–±–ª–∏—Ü—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ **Python-–∫–ª–∞—Å—Å—ã** (–º–æ–¥–µ–ª–∏).
- **–°—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü** –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ **–æ–±—ä–µ–∫—Ç—ã** —ç—Ç–∏—Ö –∫–ª–∞—Å—Å–æ–≤.
- **–ó–∞–ø—Ä–æ—Å—ã –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ **–º–µ—Ç–æ–¥—ã –∏ –∞—Ç—Ä–∏–±—É—Ç—ã** Python-–æ–±—ä–µ–∫—Ç–æ–≤.

–≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ **–±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, –ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã–º –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º** –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å —Ä—É—á–Ω—ã–º –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º SQL.

–í —à–∞–±–ª–æ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã SQLAlchemy, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –≤ `src/databases/sqlite/core.py`:

```{eval-rst}
.. uml:: ../../projectTemplate/diagrams/sqlite_core.puml
   :scale: 10%
   :align: center
```

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../src/databases/sqlite/core.py
      :language: python
      :caption: src/databases/sqlite/core.py
```

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç         | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                                   | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                                                                                            |
| :---------------- | :------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **–î–≤–∏–∂–æ–∫ (Engine)**         | **–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç** –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î.                                                  | –£–ø—Ä–∞–≤–ª—è–µ—Ç **–ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**, **–Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**, –∏ **–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö**. –û–Ω **–Ω–µ —Å–æ–∑–¥–∞—ë—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ä–∞–∑—É**, –∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É.                |
| **–§–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π (Sessionmaker)** | **–§—É–Ω–∫—Ü–∏—è**, —Å–æ–∑–¥–∞—é—â–∞—è **–Ω–æ–≤—ã–µ —Å–µ—Å—Å–∏–∏**.                                                     | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏ —É–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è** `AsyncSession` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.                                                                         |
| **–°–µ—Å—Å–∏—è (Session)**       | **–†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å** –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ë–î.                                                  | **–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (`SELECT`, `INSERT`, `UPDATE`, `DELETE`), **–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π** –æ–±—ä–µ–∫—Ç–æ–≤ –∏ **—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏**.       |
| **`@connection`** | **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä**, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É—é—â–∏–π —Å–æ–∑–¥–∞–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏.                   | **–£–ø—Ä–æ—â–∞–µ—Ç –∫–æ–¥**, –±–µ—Ä—ë—Ç –Ω–∞ —Å–µ–±—è **–æ—Ç–∫—Ä—ã—Ç–∏–µ, –ø–µ—Ä–µ–¥–∞—á—É, –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏** –∏ **–æ—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ**.                                                         |


### üöÄ –î–≤–∏–∂–æ–∫ (Engine)

–î–≤–∏–∂–æ–∫ (`Engine`) ‚Äî —ç—Ç–æ **—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç** SQLAlchemy, –∫–æ—Ç–æ—Ä—ã–π **—É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**:

- **–°–æ–∑–¥–∞—ë—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ –ë–î –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –Ω—É–ª—è, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–∂–µ –≥–æ—Ç–æ–≤–æ–µ –∏–∑ –ø—É–ª–∞, —á—Ç–æ **–ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**.
- **–§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å—ã** –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–∑ –ø—É–ª–∞.
- **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –¥—Ä–∞–π–≤–µ—Ä–æ–º** –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`aiosqlite`).

```{admonition} –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ
:class: attention

–î–≤–∏–∂–æ–∫ **–Ω–µ —Å–æ–∑–¥–∞—ë—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**. –û–Ω **—Å–æ–∑–¥–∞—ë—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é** - –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è.
```

```{admonition} –°–æ–≤–µ—Ç: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞
:class: tip
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã `SQLITE_POOL_SIZE` –∏ `SQLITE_MAX_OVERFLOW` –≤ .env –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ `POOL_SIZE` –¥–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –±–æ–ª—å—à–µ –≥–æ—Ç–æ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.
```

### üß≠ –°–µ—Å—Å–∏—è (Session)

–°–µ—Å—Å–∏—è (`Session`, –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ `AsyncSession`) ‚Äî —ç—Ç–æ **—Ä–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å** –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:

- **–Ø–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º** –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (—á–µ—Ä–µ–∑ `session.execute(query)`).
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è** –æ–±—ä–µ–∫—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —ç—Ç—É —Å–µ—Å—Å–∏—é.
- **–£–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏** (–Ω–∞—á–∏–Ω–∞–µ—Ç, —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç).
- **–ö—ç—à–∏—Ä—É–µ—Ç** –æ–±—ä–µ–∫—Ç—ã, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

```{admonition} –ß—Ç–æ —Ç–∞–∫–æ–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
:class: dropdown
:class: note

[–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è](https://ru.wikipedia.org/wiki/–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è_(–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞)) ‚Äî —ç—Ç–æ –≥—Ä—É–ø–ø–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î, –ª–æ–≥–∏—á–µ—Å–∫–∞—è –µ–¥–∏–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏. –û–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ª–∏–±–æ **–≤—Å–µ** –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ **–ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è**, –ª–∏–±–æ **–Ω–∏ –æ–¥–Ω–æ** –∏–∑ –Ω–∏—Ö (–≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏). –í SQLAlchemy —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤—ã–∑–æ–≤–æ–º `session.commit()` (–¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏) –∏–ª–∏ `session.rollback()` (–¥–ª—è –æ—Ç–∫–∞—Ç–∞).
```

#### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å–µ—Å—Å–∏–∏

| –ì—Ä—É–ø–ø–∞ –º–µ—Ç–æ–¥–æ–≤           | –ú–µ—Ç–æ–¥—ã                                        | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                                                                                  |
| :----------------------- | :-------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏** | `commit()`, `rollback()`, `flush()`           | `commit()` ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î. `rollback()` ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. `flush()` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î –±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. |
| **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ**   | `add()`, `add_all()`, `delete()`              | `add()` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç. `add_all()` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤. `delete()` ‚Äî –ø–æ–º–µ—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.                                      |
| **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**      | `get()`, `execute()`, `scalar()`, `scalars()` | `get()` ‚Äî –ø–æ–ª—É—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç –ø–æ –ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É. `execute()` ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (`select`, `update`, `delete`). `scalar()`/`scalars()` ‚Äî –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ/–º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∑–Ω–∞—á–µ–Ω–∏–π. |
| **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** | `refresh()`, `merge()`, `expire()`           | `refresh()` ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç –∞—Ç—Ä–∏–±—É—Ç—ã –æ–±—ä–µ–∫—Ç–∞ –∏–∑ –ë–î. `merge()` ‚Äî "–≤—Å—Ç–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç". `expire()` ‚Äî –ø–æ–º–µ—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–∞–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π.                        |


```{admonition} –í–∞–∂–Ω–æ: session.get() –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
:class: attention
–í SQLAlchemy 2.0+ –º–µ—Ç–æ–¥ `session.get()` —Å—Ç–∞–ª **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º** –∏ –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∫–∞–∫ `await session.get(Model, primary_key)`.
```

### üè≠ –§–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π (Sessionmaker)

–§–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π (`Sessionmaker`, –∞ –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ `async_sessionmaker`) ‚Äî —ç—Ç–æ **—Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**, –∫–æ—Ç–æ—Ä–∞—è **—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã `AsyncSession`**. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç

- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π**: –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –Ω–∞–ø—Ä—è–º—É—é, –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ñ–∞–±—Ä–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è –∑–Ω–∞–µ—Ç, —Å –∫–∞–∫–∏–º –¥–≤–∏–∂–∫–æ–º (`engine`) –∏ –∫–∞–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ—Å—Å–∏—é.
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏**: –í—Å–µ —Å–µ—Å—Å–∏–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É, –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `expire_on_commit`, `autoflush`), –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–±—Ä–∏–∫–∏.
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `@connection`**: –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@connection` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç—É —Ñ–∞–±—Ä–∏–∫—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏.

–ö–æ–≥–¥–∞ –≤—ã –≤—ã–∑—ã–≤–∞–µ—Ç–µ `async_session()` (–∫–æ—Ç–æ—Ä–∞—è –∏ –µ—Å—Ç—å –Ω–∞—à–∞ —Ñ–∞–±—Ä–∏–∫–∞), –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–Ω–æ–≤—É—é, –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é** `AsyncSession`, –≥–æ—Ç–æ–≤—É—é –∫ —Ä–∞–±–æ—Ç–µ —Å –ë–î.

### üß© –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@connection`

–î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@connection` ‚Äî —ç—Ç–æ **—É–¥–æ–±–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞**, –∫–æ—Ç–æ—Ä–∞—è **–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–µ–π**:

- **–°–æ–∑–¥–∞—ë—Ç** –Ω–æ–≤—É—é `AsyncSession` —Å –ø–æ–º–æ—â—å—é —Ñ–∞–±—Ä–∏–∫–∏.
- **–ü–µ—Ä–µ–¥–∞—ë—Ç** —ç—Ç—É —Å–µ—Å—Å–∏—é –≤ –¥–µ–∫–æ—Ä–∏—Ä—É–µ–º—É—é —Ñ—É–Ω–∫—Ü–∏—é –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç (–æ–±—ã—á–Ω–æ `session`).
- **–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç** **–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ** —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ (–¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞).
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç** `session.commit()` –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏ `session.rollback()` –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ **–∏—Å–∫–ª—é—á–µ–Ω–∏—è**, –≤–æ–∑–≤—Ä–∞—â–∞—è –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

```{admonition} –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ @connection
:class: tip
–í—Å–µ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—â–∏–µ —Å –ë–î, –≤ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@connection`. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –ø—Ä–æ—â–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ.
```

## üìä ORM

ORM (Object-Relational Mapping) ‚Äî —ç—Ç–æ **—Å–ø–æ—Å–æ–± –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** –∫–∞–∫ **Python-–∫–ª–∞—Å—Å–æ–≤**, –∞ **—Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ** ‚Äî –∫–∞–∫ **–æ–±—ä–µ–∫—Ç–æ–≤ —ç—Ç–∏—Ö –∫–ª–∞—Å—Å–æ–≤**.  

```{eval-rst}
.. uml:: ../../projectTemplate/diagrams/orm.puml
   :scale: 10%
   :align: center
```

```{admonition} –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è
:class: dropdown
- **–ú–æ–¥–µ–ª—å** ‚Äî Python-–∫–ª–∞—Å—Å, **–Ω–∞—Å–ª–µ–¥—É–µ–º—ã–π –æ—Ç `Base`**, –∫–æ—Ç–æ—Ä—ã–π **–æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
- **–ö–æ–ª–æ–Ω–∫–∞ (–∞—Ç—Ä–∏–±—É—Ç)** ‚Äî **–ø–æ–ª–µ —Ç–∞–±–ª–∏—Ü—ã**, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –∫–∞–∫ **–∞—Ç—Ä–∏–±—É—Ç –∫–ª–∞—Å—Å–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `username: Mapped[str]`).
- **–¢–∞–±–ª–∏—Ü–∞** ‚Äî **—Å—É—â–Ω–æ—Å—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**, –∫–æ—Ç–æ—Ä–∞—è **—Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–æ–¥–µ–ª–∏**.
- **–û–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏** ‚Äî **—Å—Ç—Ä–æ–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ**, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ **—Å–æ–∑–¥–∞—Ç—å, –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å** –∫–∞–∫ Python-–æ–±—ä–µ–∫—Ç.
```

### üß± –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å `Base`

–í SQLAlchemy **–≤—Å–µ ORM-–º–æ–¥–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç –æ–¥–Ω–æ–≥–æ –æ–±—â–µ–≥–æ –∫–ª–∞—Å—Å–∞** `sqlalchemy.orm.DeclarativeBase`. –î–ª—è —ç—Ç–∏—Ö —Ü–µ–ª–µ–π –≤ —à–∞–±–ª–æ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å `Base`**, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `src/databases/sqlite/models/base.py` –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü** ‚Äî SQLAlchemy –∑–Ω–∞–µ—Ç, –∫–∞–∫–∏–µ –º–æ–¥–µ–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –∏ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î.
- **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏** ‚Äî –≤—Å–µ –º–æ–¥–µ–ª–∏, –Ω–∞—Å–ª–µ–¥—É—é—â–∏–µ—Å—è –æ—Ç `Base`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–ª—è, –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ `Base`.
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã** ‚Äî –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `__tablename__` –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∞—Å—Å–∞ –≤ –º–æ–¥–µ–ª–∏ (`User` ‚Üí `users`, `Post` ‚Üí `posts`)
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π** ‚Äî Alembic –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `Base.metadata` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å—Ö–µ–º–µ –ë–î.

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../src/databases/sqlite/models/base.py
      :language: python
      :caption: src/databases/sqlite/models/base.py
```

### üß© –ú–æ–¥–µ–ª—å `User`

–§–∞–π–ª `src/databases/sqlite/models/user.py` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–º–µ—Ä ORM-–º–æ–¥–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ú–æ–¥–µ–ª—å `User` –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `Base` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:

- `id` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –∏–∑ `Base`)
- `username` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –∏–Ω–¥–µ–∫—Å–æ–º)
- `email` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –∏–Ω–¥–µ–∫—Å–æ–º)

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../src/databases/sqlite/models/user.py
      :language: python
      :caption: src/databases/sqlite/models/user.py
```
```{admonition} –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ __repr__
:class: tip
–ú–µ—Ç–æ–¥ __repr__ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–¥–æ–±–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ª–æ–≥–∞—Ö –∏–ª–∏ –≤ REPL).
```

### üèóÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–π—Ç–µ **ORM-–º–æ–¥–µ–ª—å** –≤ `src/databases/sqlite/models/`.

–ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–¥–∏–º –º–æ–¥–µ–ª—å `Post`:

```python
from sqlalchemy import String, Text
from sqlalchemy.orm import Mapped, mapped_column
from .base import Base

class Post(Base):
    """
    ORM-–º–æ–¥–µ–ª—å –ø–æ—Å—Ç–∞ —é–∑–µ—Ä–∞ –≤ –±–ª–æ–≥–µ.
    """

    title: Mapped[str] = mapped_column(String, index=True)
    content: Mapped[str] = mapped_column(Text)

    def __repr__(self):
        return f"<Post(id={self.id}, title='{self.title}')>"
```

```{admonition} –°–æ–≤–µ—Ç: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ __repr__ –≤ –º–æ–¥–µ–ª—è—Ö
:class: tip
–ú–µ—Ç–æ–¥ `__repr__` –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–¥–æ–±–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ª–æ–≥–∞—Ö –∏–ª–∏ –≤ REPL).
```

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ):

–ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –≤ –∫–ª–∞—Å—Å –º–æ–¥–µ–ª–∏:

```python
from sqlalchemy import Boolean, Integer
from sqlalchemy.orm import Mapped, mapped_column

class User(Base):
    username: Mapped[str] = mapped_column(String, unique=True, index=True)
    email: Mapped[str] = mapped_column(String, unique=True, index=True)
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)  # ‚Üê –Ω–æ–≤–æ–µ –ø–æ–ª–µ
```

### üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –≤ –ë–î

–ü–æ—Å–ª–µ **—Å–æ–∑–¥–∞–Ω–∏—è** –∏–ª–∏ **–∏–∑–º–µ–Ω–µ–Ω–∏—è** –º–æ–¥–µ–ª–∏ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –µ—ë** –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

1.  `alembic/env.py` ‚Äî —á—Ç–æ–±—ã Alembic –º–æ–≥ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏.
2.  `src/databases/sqlite/models/__init__.py` ‚Äî –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è.

#### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `alembic/env.py`

–í `alembic/env.py` **–∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ** –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã **Alembic –≤–∏–¥–µ–ª –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ** –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π.

```python
from src.databases.sqlite.models.base import Base
from src.databases.sqlite.models.user import User  # noqa: F401
from src.databases.sqlite.models.post import Post  # noqa: F401 <-- –ù–û–í–ê–Ø –ú–û–î–ï–õ–¨
```

```{admonition} –ó–∞—á–µ–º –Ω—É–∂–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π # noqa: F401
:class: dropdown
:class: note

–í —à–∞–±–ª–æ–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ö—É–∫ ruff, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ pre-commit.
–ü—Ä–∞–≤–∏–ª–æ F401 —É–¥–∞–ª—è–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã.

–ú–æ–¥–µ–ª—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ alembic/env.py, –Ω–æ Alembic –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –æ –µ—ë —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏,
—á—Ç–æ–±—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü.

–ò–º–ø–æ—Ä—Ç —Å # noqa: F401 –≥–æ–≤–æ—Ä–∏—Ç ruff, —á—Ç–æ–±—ã –Ω–µ —É–¥–∞–ª—è–ª —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç,
–ø–æ—Å–∫–æ–ª—å–∫—É –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Alembic.
```

#### –≠–∫—Å–ø–æ—Ä—Ç –≤ `src/databases/sqlite/models/__init__.py`

–û–±–Ω–æ–≤–∏—Ç–µ `src/databases/sqlite/models/__init__.py`, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å –≤ —Å–ø–∏—Å–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞:

```python
"""
–ú–æ–¥—É–ª—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö ORM-–º–æ–¥–µ–ª–µ–π SQLite.

–ó–¥–µ—Å—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã Alembic –º–æ–≥ –∏—Ö –≤–∏–¥–µ—Ç—å.
"""

from .user import User
from .post import Post  # <-- –¥–æ–±–∞–≤—å—Ç–µ –∏–º–ø–æ—Ä—Ç

__all__ = [
    "User",
    "Post",  # <-- –¥–æ–±–∞–≤—å—Ç–µ –∏–º–ø–æ—Ä—Ç –≤ —Å–ø–∏—Å–æ–∫
]
```

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ **–¥–æ–±–∞–≤–ª–µ–Ω–∏—è** –∏–ª–∏ **–∏–∑–º–µ–Ω–µ–Ω–∏—è** –º–æ–¥–µ–ª–∏ **–≤—Å–µ–≥–¥–∞** –≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏ –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:

1.  –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:

    ```bash
    alembic revision --autogenerate -m "Add Post model"  # –∏–ª–∏ "Add is_active field to User"
    ```

2.  –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:

    ```bash
    alembic upgrade head
    ```

–≠—Ç–æ **—Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É** –∏–ª–∏ **–æ–±–Ω–æ–≤–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

```{admonition} –ü–æ–¥—Ä–æ–±–Ω–µ–µ
:class: dropdown
:class: seealso

–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. –≤ —Ä–∞–∑–¥–µ–ª–µ Alembic
```

### üîó –û—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É ORM-–º–æ–¥–µ–ª—è–º–∏

SQLAlchemy –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø–∏—Å—ã–≤–∞—Ç—å **–æ—Ç–Ω–æ—à–µ–Ω–∏—è (relationships)** –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏, —á—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

| –ì—Ä—É–ø–ø–∞ | –ü–æ–Ω—è—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏** | `relationship()` | –§—É–Ω–∫—Ü–∏—è SQLAlchemy –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏. |
| | `Mapped[...]` | –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è —Ç–∏–ø–∞ –¥–ª—è –ø–æ–ª—è —Å–≤—è–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Mapped["Profile"]`). |
| | `ForeignKey` | –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á, —Å–æ–µ–¥–∏–Ω—è—é—â–∏–π —Ç–∞–±–ª–∏—Ü—ã. |
| | `secondary` | –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è Many-to-Many. |
| **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–∏** | `back_populates` | –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–≤—è–∑–∞–Ω–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω. |
| | `uselist` | `False` –¥–ª—è One-to-One, `True` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –¥–ª—è One-to-Many/Many-to-One. |
| | `lazy` | –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `lazy="joined"`). –ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–¥–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö". |
| **–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏** | `cascade` | –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `cascade="all, delete-orphan"`). |

#### –¢–∏–ø—ã –æ—Ç–Ω–æ—à–µ–Ω–∏–π

```{eval-rst}
.. list-table::
   :header-rows: 1
   :widths: 12 18 12 12 18

   * - –¢–∏–ø –æ—Ç–Ω–æ—à–µ–Ω–∏—è
     - –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
     - –ü—Ä–∏–º–µ—Ä
     - –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
     - –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

   * - **One-to-One (–û–¥–∏–Ω –∫ –æ–¥–Ω–æ–º—É)**
     - | –°–≤—è–∑—ã–≤–∞–µ—Ç –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ —Å –æ–¥–Ω–∏–º —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º –¥—Ä—É–≥–æ–π.
       | –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–∏ –Ω–∞ –¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã.
     - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å.
     - ``uselist=False``, ``back_populates``
     - | –ö–æ–≥–¥–∞ —É –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ –µ—Å—Ç—å –æ–¥–∏–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç/–¥–æ–∫—É–º–µ–Ω—Ç,
       | –∫–æ—Ç–æ—Ä—ã–π –ª–æ–≥–∏—á–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É.

   * - **One-to-Many / Many-to-One (–û–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º / –ú–Ω–æ–≥–∏–µ –∫ –æ–¥–Ω–æ–º—É)**
     - | –°–≤—è–∑—ã–≤–∞–µ—Ç –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ –¥—Ä—É–≥–æ–π (–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç).
     - –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –º–Ω–æ–≥–æ –ø–æ—Å—Ç–æ–≤.
     - ``ForeignKey``, ``back_populates``, ``cascade`` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
     - | –ö–æ–≥–¥–∞ –æ–¥–Ω–∞ —Å—É—â–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç "–≤–ª–∞–¥–µ—Ç—å" –∏–ª–∏ –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥—Ä—É–≥–∏–º–∏ —Å—É—â–Ω–æ—Å—Ç—è–º–∏.

   * - **Many-to-Many (–ú–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º)**
     - | –°–≤—è–∑—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ –¥—Ä—É–≥–æ–π.
       | –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.
     - | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ —Ç–µ–≥–∏ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ–≥–æ–≤,
       | —Ç–µ–≥ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏—Å–≤–æ–µ–Ω –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º).
     - ``secondary`` (—É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É), ``back_populates``
     - | –ö–æ–≥–¥–∞ –º–µ–∂–¥—É –¥–≤—É–º—è —Å—É—â–Ω–æ—Å—Ç—è–º–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å–ª–æ–∂–Ω–∞—è —Å–≤—è–∑—å,
       | –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –∫–∞–∂–¥–∞—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ –¥—Ä—É–≥–æ–π.
```

##### üîÑ One-to-One (–û–¥–∏–Ω –∫ –æ–¥–Ω–æ–º—É)

–°–≤—è–∑—å "–æ–¥–∏–Ω-–∫-–æ–¥–Ω–æ–º—É" (`One-to-One`) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ **–æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä** –ø–µ—Ä–≤–æ–π –º–æ–¥–µ–ª–∏ —Å–≤—è–∑–∞–Ω **—Ä–æ–≤–Ω–æ —Å –æ–¥–Ω–∏–º —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º** –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç. –≠—Ç–∞ —Å–≤—è–∑—å —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è** —Å—É—â–Ω–æ—Å—Ç–∏ –Ω–∞ –¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –æ—Ç–¥–µ–ª–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –∏–ª–∏ —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ —É –æ—Å–Ω–æ–≤–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ –µ—Å—Ç—å –æ–¥–∏–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç/–¥–æ–∫—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ª–æ–≥–∏—á–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Ö—Ä–∞–Ω–µ–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π).

**–ö–∞–∫ —ç—Ç–æ —É—Å—Ç—Ä–æ–µ–Ω–æ –≤ SQLAlchemy:**

1.  **`ForeignKey`:** –û–±—ã—á–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ "–¥–æ—á–µ—Ä–Ω–µ–π" –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Profile`). –û–Ω–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (`id`) "—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π" –º–æ–¥–µ–ª–∏ (`User`).
2.  **`relationship()` –∏ `Mapped[...]`:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–≤—è–∑—å. –í –º–æ–¥–µ–ª–∏ `User` —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ–ª–µ `profile: Mapped["Profile"]`.
3.  **`uselist=False`:** –≠—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ `relationship()`, —á—Ç–æ–±—ã SQLAlchemy –ø–æ–Ω–∏–º–∞–ª, —á—Ç–æ —Å–≤—è–∑—å **–æ–¥–∏–Ω-–∫-–æ–¥–Ω–æ–º—É**, –∞ –Ω–µ –æ–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º. SQLAlchemy –æ–∂–∏–¥–∞–µ—Ç **–æ–¥–∏–Ω** –æ–±—ä–µ–∫—Ç, –∞ –Ω–µ —Å–ø–∏—Å–æ–∫.
4.  **`back_populates`:** –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é** —Å–≤—è–∑—å. –ï—Å–ª–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ `user.profile`, –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ `profile.user`.

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:**

```python
from sqlalchemy.orm import Mapped, relationship
from sqlalchemy import ForeignKey, String, Text
from .base import Base

class User(Base):

    username: Mapped[str] = mapped_column(String, unique=True, index=True)

    # –°–≤—è–∑—å –æ–¥–∏–Ω-–∫-–æ–¥–Ω–æ–º—É —Å Profile
    # uselist=False —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –Ω–µ —Å–ø–∏—Å–æ–∫, –∞ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç
    profile: Mapped["Profile"] = relationship(
        "Profile",              # –ò–º—è —Å–≤—è–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        back_populates="user",  # –ò–º—è –ø–æ–ª—è —Å–≤—è–∑–∏ –≤ –º–æ–¥–µ–ª–∏ Profile
        uselist=False,          # –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–≤—è–∑—å –æ–¥–∏–Ω-–∫-–æ–¥–Ω–æ–º—É
        lazy="joined"           # –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ (—Å–º. —Ä–∞–∑–¥–µ–ª "–ü–æ–¥–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
    )

class Profile(Base):

    bio: Mapped[str] = mapped_column(Text)
    # ForeignKey —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–∞–±–ª–∏—Ü—É "users" –∏ –∫–æ–ª–æ–Ω–∫—É "id"
    user_id: Mapped[int] = mapped_column(ForeignKey("users.id"), unique=True) # unique=True —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—é—Ç –¥–ª—è One-to-One

    # –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    user: Mapped["User"] = relationship(
        "User",                 # –ò–º—è —Å–≤—è–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        back_populates="profile", # –ò–º—è –ø–æ–ª—è —Å–≤—è–∑–∏ –≤ –º–æ–¥–µ–ª–∏ User
        uselist=False           # –û–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –º–æ–≥—É—Ç –∏–º–µ—Ç—å uselist=False –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    )
```

```{admonition} –ü–æ—á–µ–º—É unique=True –≤ user_id?
:class: tip
–•–æ—Ç—è `uselist=False` –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `User` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —É –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–æ—Ñ–∏–ª—å, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `unique=True` –Ω–∞ `user_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `profiles` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ *–æ–¥–∏–Ω* `user_id` –Ω–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ *–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö* —Å—Ç—Ä–æ–∫–∞—Ö —Ç–∞–±–ª–∏—Ü—ã `profiles`. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
```

##### üîÑ One-to-Many / Many-to-One (–û–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º / –ú–Ω–æ–≥–∏–µ –∫ –æ–¥–Ω–æ–º—É)

–°–≤—è–∑—å "–æ–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º" (`One-to-Many`) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ **–æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä** –ø–µ—Ä–≤–æ–π –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Author`) –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω —Å **–º–Ω–æ–∂–µ—Å—Ç–≤–æ–º** —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Book`). –° —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏ —ç—Ç–æ "–º–Ω–æ–≥–∏–µ-–∫-–æ–¥–Ω–æ–º—É" (`Many-to-One`), —Ç–∞–∫ –∫–∞–∫ **–º–Ω–æ–∂–µ—Å—Ç–≤–æ** —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ (`Book`) —Å–≤—è–∑–∞–Ω—ã —Å **–æ–¥–Ω–∏–º** —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º (`Author`). –≠—Ç–æ **–æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑—å**, —Å–º–æ—Ç—Ä—è—â–∞—è —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ –æ–¥–Ω–∞ —Å—É—â–Ω–æ—Å—Ç—å "–≤–ª–∞–¥–µ–µ—Ç" –∏–ª–∏ "—Å–æ–¥–µ—Ä–∂–∏—Ç" –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥—Ä—É–≥–∏—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –µ–≥–æ –ø–æ—Å—Ç—ã, –∫–æ–º–ø–∞–Ω–∏—è –∏ –µ—ë —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –∑–∞–∫–∞–∑ –∏ –µ–≥–æ –ø–æ–∑–∏—Ü–∏–∏).

**–ö–∞–∫ —ç—Ç–æ —É—Å—Ç—Ä–æ–µ–Ω–æ –≤ SQLAlchemy:**

1.  **`ForeignKey`:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ "–¥–æ—á–µ—Ä–Ω–µ–π" –º–æ–¥–µ–ª–∏ (`Book`), —É–∫–∞–∑—ã–≤–∞—è –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (`id`) "—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π" –º–æ–¥–µ–ª–∏ (`Author`). –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Å–≤—è–∑—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
2.  **`relationship()` –≤ "—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π" –º–æ–¥–µ–ª–∏ (`Author`):** –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª–µ `books: Mapped[list["Book"]]`. SQLAlchemy –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–∂–∏–¥–∞–µ—Ç **—Å–ø–∏—Å–æ–∫** —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (`uselist=True` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).
3.  **`relationship()` –≤ "–¥–æ—á–µ—Ä–Ω–µ–π" –º–æ–¥–µ–ª–∏ (`Book`):** –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª–µ `author: Mapped["Author"]`. SQLAlchemy –æ–∂–∏–¥–∞–µ—Ç **–æ–¥–∏–Ω** —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –æ–±—ä–µ–∫—Ç.
4.  **`back_populates`:** –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Å–≤—è–∑—å.
5.  **`cascade`:** –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä.
```{admonition} –ü–æ—è—Å–Ω–µ–Ω–∏–µ: cascade=all, delete-orphan
:class: tip
:class: dropdown
- `all`: –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (`save-update`, `merge`, `refresh-expire`, `expunge`, `delete`) –∫ –¥–æ—á–µ—Ä–Ω–∏–º –æ–±—ä–µ–∫—Ç–∞–º. –í –æ—Å–Ω–æ–≤–Ω–æ–º, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö –±—É–¥—É—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å—Å—è –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—è.
- `delete-orphan`: –ï—Å–ª–∏ –¥–æ—á–µ—Ä–Ω–∏–π –æ–±—ä–µ–∫—Ç (`Post`) –æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è (`User`) –∏ –±–æ–ª—å—à–µ –Ω–µ —Å–≤—è–∑–∞–Ω –Ω–∏ —Å –∫–∞–∫–∏–º –¥—Ä—É–≥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –æ–±—ä–µ–∫—Ç–æ–º, –æ–Ω –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—ë–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º `commit()`. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ" –∑–∞–ø–∏—Å–∏.
```

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:**

```python
from sqlalchemy.orm import Mapped, relationship
from sqlalchemy import ForeignKey, String, Text, Integer

class User(Base): # "–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è" –º–æ–¥–µ–ª—å

    username: Mapped[str] = mapped_column(String, unique=True, index=True)

    # –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –º–Ω–æ–≥–æ –ø–æ—Å—Ç–æ–≤ (One-to-Many)
    # SQLAlchemy –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–∂–∏–¥–∞–µ—Ç —Å–ø–∏—Å–æ–∫ (uselist=True)
    posts: Mapped[list["Post"]] = relationship(
        "Post",                 # –ò–º—è —Å–≤—è–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        back_populates="user",  # –ò–º—è –ø–æ–ª—è —Å–≤—è–∑–∏ –≤ –º–æ–¥–µ–ª–∏ Post
        cascade="all, delete-orphan", # –£–¥–∞–ª—è–µ—Ç –ø–æ—Å—Ç—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        lazy="select"           # –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ (—Å–º. —Ä–∞–∑–¥–µ–ª "–ü–æ–¥–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
    )

class Post(Base): # "–î–æ—á–µ—Ä–Ω—è—è" –º–æ–¥–µ–ª—å

    title: Mapped[str] = mapped_column(String, index=True)
    content: Mapped[str] = mapped_column(Text)
    # ForeignKey —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–∞–±–ª–∏—Ü—É "users" –∏ –∫–æ–ª–æ–Ω–∫—É "id"
    user_id: Mapped[int] = mapped_column(ForeignKey("users.id"))

    # –ú–Ω–æ–≥–∏–µ –ø–æ—Å—Ç—ã ‚Äî –∫ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (Many-to-One)
    user: Mapped["User"] = relationship(
        "User",                 # –ò–º—è —Å–≤—è–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        back_populates="posts"  # –ò–º—è –ø–æ–ª—è —Å–≤—è–∑–∏ –≤ –º–æ–¥–µ–ª–∏ User
    )
```

##### üîÑ Many-to-Many (–ú–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º)

–°–≤—è–∑—å "–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º" (`Many-to-Many`) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ **–º–Ω–æ–∂–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤** –ø–µ—Ä–≤–æ–π –º–æ–¥–µ–ª–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å **–º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤** –≤—Ç–æ—Ä–æ–π –º–æ–¥–µ–ª–∏. –≠—Ç–∞ —Å–≤—è–∑—å —Ç—Ä–µ–±—É–µ—Ç **–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã** (–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏), –≤ –∫–æ—Ç–æ—Ä–æ–π —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–∞—Ä—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤, —Å–æ–µ–¥–∏–Ω—è—é—â–∏—Ö –∑–∞–ø–∏—Å–∏ –∏–∑ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ –º–µ–∂–¥—É –¥–≤—É–º—è —Å—É—â–Ω–æ—Å—Ç—è–º–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å–ª–æ–∂–Ω–∞—è —Å–≤—è–∑—å, –∏ –∫–∞–∂–¥–∞—è –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ –¥—Ä—É–≥–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–≥–∏ –∏ —Å—Ç–∞—Ç—å–∏, –≤—Ä–∞—á–∏ –∏ –ø–∞—Ü–∏–µ–Ω—Ç—ã, —Å—Ç—É–¥–µ–Ω—Ç—ã –∏ –∫—É—Ä—Å—ã).

**–ö–∞–∫ —ç—Ç–æ —É—Å—Ç—Ä–æ–µ–Ω–æ –≤ SQLAlchemy:**

1.  **`Table` (–∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞):** –°–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç `Table`, –Ω–µ —è–≤–ª—è—é—â–∏–π—Å—è ORM-–º–æ–¥–µ–ª—å—é. –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç **–¥–≤–µ** `ForeignKey`, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (`id`) –æ–¥–Ω–æ–π –∏–∑ —Å–≤—è–∑—ã–≤–∞–µ–º—ã—Ö ORM-–º–æ–¥–µ–ª–µ–π (`User` –∏ `Tag`).
2.  **`relationship()` –≤ –æ–±–µ–∏—Ö –º–æ–¥–µ–ª—è—Ö:** –í –æ–±–µ–∏—Ö ORM-–º–æ–¥–µ–ª—è—Ö (`User` –∏ `Tag`) —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ–ª—è `Mapped[list[...]]`, –∏—Å–ø–æ–ª—å–∑—É—è `relationship()`.
3.  **`secondary`:** –í `relationship()` —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–º—è –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `secondary=user_tag_association`), —á—Ç–æ–±—ã SQLAlchemy –∑–Ω–∞–ª, –≥–¥–µ –∏—Å–∫–∞—Ç—å —Å–≤—è–∑—å.
4.  **`back_populates`:** –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Å–≤—è–∑—å.

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:**

```python
from sqlalchemy import Table, Column, Integer, ForeignKey, String
from sqlalchemy.orm import Mapped, relationship

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è (–∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∞—è) —Ç–∞–±–ª–∏—Ü–∞
user_tag_association = Table(
    "user_tags",              # –ò–º—è –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
    Base.metadata,            # –°–≤—è–∑—ã–≤–∞–µ–º —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ Base
    Column("user_id", Integer, ForeignKey("users.id")), # FK –Ω–∞ —Ç–∞–±–ª–∏—Ü—É users
    Column("tag_id", Integer, ForeignKey("tags.id"))    # FK –Ω–∞ —Ç–∞–±–ª–∏—Ü—É tags
)

class User(Base):

    username: Mapped[str] = mapped_column(String, unique=True, index=True)

    # –ú–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º: —Å–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤
    tags: Mapped[list["Tag"]] = relationship(
        "Tag",                          # –ò–º—è —Å–≤—è–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        secondary=user_tag_association, # –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        back_populates="users"          # –ò–º—è –ø–æ–ª—è —Å–≤—è–∑–∏ –≤ –º–æ–¥–µ–ª–∏ Tag
    )

class Tag(Base):

    name: Mapped[str] = mapped_column(String, unique=True)

    # –ú–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º: —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    users: Mapped[list["User"]] = relationship(
        "User",                         # –ò–º—è —Å–≤—è–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        secondary=user_tag_association, # –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        back_populates="tags"           # –ò–º—è –ø–æ–ª—è —Å–≤—è–∑–∏ –≤ –º–æ–¥–µ–ª–∏ User
    )
```

**–ü–ª–∞–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:**

1.  **–í–≤–µ–¥–µ–Ω–∏–µ –≤ Pydantic-—Å—Ö–µ–º—ã –¥–ª—è SQLAlchemy:**
    *   –ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, —á—Ç–æ —Ç–∞–∫–æ–µ Pydantic-—Å—Ö–µ–º—ã.
    *   –ó–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã: –≤–∞–ª–∏–¥–∞—Ü–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è.
    *   –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQLAlchemy.
    *   –ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `src/databases/sqlite/schemas.py`).

2.  **Pydantic-—Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö):**
    *   –ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –¥–ª—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserCreateSchema`).
    *   –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ FastAPI (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ) –∏–ª–∏ –≤ DAO –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.
    *   –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.

3.  **Pydantic-—Å—Ö–µ–º—ã –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–≤—ã—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö):**
    *   –ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserResponseSchema`).
    *   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `from_attributes=True`.
    *   –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ SQLAlchemy –≤ Pydantic-–æ–±—ä–µ–∫—Ç: `PydanticSchema.from_orm(sqla_obj)`.
    *   –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Pydantic-–æ–±—ä–µ–∫—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä—å: `pydantic_obj.model_dump()`.
    *   –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `to_dict()` –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (–∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ–ª–µ–π, —Ç–∏–ø–æ–≤ –∏ —Ç.–¥.).
    *   –ü—Ä–∏–º–µ—Ä: –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ –ë–î –∏ –≤–æ–∑–≤—Ä–∞—Ç –µ–≥–æ –≤ –≤–∏–¥–µ Pydantic-—Å—Ö–µ–º—ã.

## üìã Pydantic

Pydantic ‚Äî —ç—Ç–æ –º–æ—â–Ω–∞—è **–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö** –¥–ª—è Python. –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ SQLAlchemy, Pydantic-—Å—Ö–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è:

*   **–í–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:** –ü—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ, –ø–æ—Å—Ç—É–ø–∞—é—â–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ API –∏–ª–∏ —Ñ–æ—Ä–º—ã), —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É –∏ —Ç–∏–ø–∞–º.
*   **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:** –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ SQLAlchemy (–º–æ–¥–µ–ª–µ–π –ë–î) –≤ —á—ë—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–æ–±—ã—á–Ω–æ —Å–ª–æ–≤–∞—Ä–∏ –∏–ª–∏ JSON), –≥–æ—Ç–æ–≤—ã–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∫–ª–∏–µ–Ω—Ç—É –∏–ª–∏ –¥—Ä—É–≥–æ–º—É —Å–µ—Ä–≤–∏—Å—É.
*   **–û–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –ö–æ–Ω—Ç—Ä–æ–ª—è, –∫–∞–∫–∏–µ –ø–æ–ª—è –∏ –∫–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏–∑/–≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∑–≤–æ–ª—è—è –∏—Å–∫–ª—é—á–∏—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ö—ç—à–∏ –ø–∞—Ä–æ–ª–µ–π) –∏–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
*   **–ü–æ–≤—ã—à–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞:** –ó–∞ —Å—á—ë—Ç —è–≤–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö.

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQLAlchemy** –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞–∫ ORM (—É–¥–æ–±–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏), —Ç–∞–∫ –∏ Pydantic (–∂—ë—Å—Ç–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è). Pydantic –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ "–º–∞–ø–ø–∏—Ç—å" –∞—Ç—Ä–∏–±—É—Ç—ã –æ–±—ä–µ–∫—Ç–æ–≤ SQLAlchemy –≤ —Å–≤–æ–∏ –ø–æ–ª—è, –∏—Å–ø–æ–ª—å–∑—É—è –æ–ø—Ü–∏—é `from_attributes=True`.

–í —à–∞–±–ª–æ–Ω–µ –≤—Å–µ Pydantic-—Å—Ö–µ–º—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å SQLite, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –ø–∞–ø–∫–µ `src/databases/sqlite/schemas/`. –ö–∞–∂–¥–∞—è —Å—É—â–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `User`) –∏–º–µ–µ—Ç —Å–≤–æ–π —Ñ–∞–π–ª —Å—Ö–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `user.py`), —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ä–∞–∑–Ω—ã–µ —Å—Ö–µ–º—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–ª–µ–π (–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞).

```{eval-rst}
.. uml:: ../../projectTemplate/diagrams/pydantic_orm.puml
   :scale: 10%
   :align: center
```

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../src/databases/sqlite/schemas/user.py
      :language: python
      :caption: src/databases/sqlite/schemas/user.py
```

```{admonition} –°–æ–≤–µ—Ç: –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è Pydantic-—Å—Ö–µ–º
:class: tip
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å **—Ä–∞–∑–Ω—ã–µ —Å—Ö–µ–º—ã** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –¥–æ–±–∞–≤–ª—è—è Request/Response –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏:

**–î–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (Requests):**
*   ``UserCreateRequest`` ‚Äî –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ *—Å–æ–∑–¥–∞–Ω–∏–∏*.
*   ``UserUpdateRequest`` ‚Äî –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ *–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏* (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä—É–≥–æ–π, —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏).
*   ``{Entity}OtherOperationRequest`` ‚Äî –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

**–î–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (Responses):**
*   ``UserResponse`` ‚Äî –¥–ª—è *–æ—Å–Ω–æ–≤–Ω–æ–π* —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö.
*   ``UserPublicResponse`` ‚Äî –¥–ª—è *–ø—É–±–ª–∏—á–Ω–æ–≥–æ* –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–µ–∑ email).
*   ``{Entity}DetailedResponse`` ‚Äî –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ API-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è), –≤–∞–∂–Ω–æ **–ø—Ä–æ–≤–µ—Ä–∏—Ç—å** –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ *–¥–æ* –ø–æ–ø—ã—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ ORM (SQLAlchemy) –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î.

**–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç:**

*   **–û–ø—Ä–µ–¥–µ–ª—è—Ç—å –æ–∂–∏–¥–∞–µ–º—ã–µ –ø–æ–ª—è –∏ –∏—Ö —Ç–∏–ø—ã** (`str`, `int`, `EmailStr` –∏ —Ç.–¥.).
*   **–ù–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏, —Ñ–æ—Ä–º–∞—Ç email, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã).
*   **–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫–∏–µ –ø–æ–ª—è –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è**, –∏—Å–∫–ª—é—á–∞—è –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `id` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏).
*   **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞–º–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, FastAPI) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

### –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–°—Ö–µ–º—ã –æ—Ç–≤–µ—Ç–∞)

–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è), –≤–∞–∂–Ω–æ **–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å**, *–∫–∞–∫–∏–µ –ø–æ–ª—è –∏ –≤ –∫–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ* –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ö–µ—à –ø–∞—Ä–æ–ª—è) –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ API.

**–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

*   **–ö–æ–Ω—Ç—Ä–æ–ª—å –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:** –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç, *–∫–∞–∫–∏–µ –ø–æ–ª—è* –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –≤ –æ—Ç–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, `id`, `username`, `email`), –∏ *–∫–∞–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω—ã* (–Ω–∞–ø—Ä–∏–º–µ—Ä, `password_hash`, `is_admin`).
*   **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –Ø—Å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞.
*   **–ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–∑ ORM-–æ–±—ä–µ–∫—Ç–∞:** –ë–ª–∞–≥–æ–¥–∞—Ä—è `from_attributes=True`, –æ–±—ä–µ–∫—Ç SQLAlchemy –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ Pydantic-–æ–±—ä–µ–∫—Ç: `UserResponse.from_orm(user_instance)`. –ó–∞—Ç–µ–º –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å: `user_response.model_dump()`.

## üèóÔ∏è DAO

DAO (Data Access Object) ‚Äî —ç—Ç–æ **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω**, –∫–æ—Ç–æ—Ä—ã–π **–∞–±—Å—Ç—Ä–∞–≥–∏—Ä—É–µ—Ç** —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –æ—Ç **–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

```{eval-rst}
.. uml:: ../../projectTemplate/diagrams/dao.puml
   :scale: 10%
   :align: center
```

**–¶–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è DAO-–ø–∞—Ç—Ç–µ—Ä–Ω–∞:**

*   **–ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å** –¥–µ—Ç–∞–ª–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
*   **–£–ø—Ä–æ—Å—Ç–∏—Ç—å** –∏ **—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å** —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è DAO-–ø–∞—Ç—Ç–µ—Ä–Ω–∞:**

*   **–ß–∏—Å—Ç–æ—Ç–∞ –∫–æ–¥–∞:** –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ **–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç SQL-–∑–∞–ø—Ä–æ—Å–æ–≤** –∏–ª–∏ –¥–µ—Ç–∞–ª–µ–π –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ë–î. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –ª–µ–≥—á–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
*   **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è:** DAO –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ ORM-–º–æ–¥–µ–ª—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserDAO`, `PostDAO` –º–æ–≥—É—Ç –∏–º–µ—Ç—å –ø–æ—Ö–æ–∂–∏–µ –º–µ—Ç–æ–¥—ã `add`, `find_one_or_none_by_id`).
*   **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:** –õ–µ–≥–∫–æ **–¥–æ–±–∞–≤–ª—è—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã** –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ DAO-–∫–ª–∞—Å—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserDAO.find_active_users_by_role(...)`).
*   **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –£–ø—Ä–æ—â–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥—Ä—É–≥—É—é –ë–î –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è) –±–µ–∑ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –≤—Å–µ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

```{admonition} –í–∞–∂–Ω–æ
:class: warning
`DAO` –ø–æ–¥—Ö–æ–¥–∏—Ç **—Ç–æ–ª—å–∫–æ –¥–ª—è SQL-–±–∞–∑ –¥–∞–Ω–Ω—ã—Ö**, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç SQLAlchemy.  
–î–ª—è Redis, –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –ë–î –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–¥—Ä—É–≥–∏–µ –ø–æ–¥—Ö–æ–¥—ã**.
```

### –ö–ª–∞—Å—Å `BaseDAO`

–ö–ª–∞—Å—Å `BaseDAO` ‚Äî —ç—Ç–æ **–±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å**, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ **–Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –≤—Å–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ DAO-–∫–ª–∞—Å—Å—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserDAO`, `PostDAO`). –ï–≥–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî **–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –æ–±—â–∏–µ, —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö**, —Ç–∞–∫–∏–µ –∫–∞–∫ **–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ**, **–ø–æ–ª—É—á–µ–Ω–∏–µ**, **–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –∏ **—É–¥–∞–ª–µ–Ω–∏–µ** –∑–∞–ø–∏—Å–µ–π, –∏ —Ç–µ–º —Å–∞–º—ã–º **–∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞**.

–ö–æ–≥–¥–∞ –í—ã —Å–æ–∑–¥–∞—ë—Ç–µ –Ω–æ–≤—ã–π DAO (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserDAO`), –í—ã —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ –µ–º—É, *—Å –∫–∞–∫–æ–π* ORM-–º–æ–¥–µ–ª—å—é –æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `model = User`). –ó–∞—Ç–µ–º `BaseDAO` –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `add`, `find_one_or_none_by_id`), –Ω–µ –∑–Ω–∞—è *–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö* –ø–æ–ª–µ–π –º–æ–¥–µ–ª–∏ `User`.

```{admonition} –ò–¥–µ—è: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `BaseDAO`
:class: tip
–í –±—É–¥—É—â–µ–º –≤ `BaseDAO` –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å **–¥—Ä—É–≥–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã**, —Ç–∞–∫–∏–µ –∫–∞–∫ `find_one_or_none_by_id`, `update_one_by_id`, `delete_one_by_id`, `find_all` –∏ —Ç.–¥., —á—Ç–æ–±—ã **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å** —Ä–∞–±–æ—Ç—É —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—É—â–Ω–æ—Å—Ç—è–º–∏.
```

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../src/databases/dao/base.py
      :language: python
      :caption: src/databases/dao/base.py
```

### –ö–ª–∞—Å—Å `UserDAO`

–ö–ª–∞—Å—Å `UserDAO` ‚Äî —ç—Ç–æ **–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** DAO-–ø–∞—Ç—Ç–µ—Ä–Ω–∞, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è –¥–ª—è **–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å ORM-–º–æ–¥–µ–ª—å—é `User`**. –û–Ω **–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è** –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ `BaseDAO`, —Ç–µ–º —Å–∞–º—ã–º **–Ω–∞—Å–ª–µ–¥—É—è** –æ–±—â–∏–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π Create, Update, Delete (–º–µ—Ç–æ–¥—ã `add`, `add_many`, `update_one_by_id`, `update_many_by_filter`, `delete_one_by_id`, `delete_many_by_filter` –∏ —Ç.–¥., –µ—Å–ª–∏ –æ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `BaseDAO`).

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../src/databases/dao/user_dao.py
      :language: python
      :caption: src/databases/dao/user_dao.py
```

```{admonition} –°–æ–≤–µ—Ç
:class: tip

–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç BaseDAO
```

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏ `UserDAO`:**

1.  **–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ–±—â–∏—Ö –º–µ—Ç–æ–¥–æ–≤:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏–∑ `BaseDAO` –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserDAO.add(...)`).
2.  **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ **—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤**, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `get_all_users`, `find_active_users`, `add_user_with_profile`).
3.  **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞:** –í–µ—Å—å –∫–æ–¥, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º, —Å–æ–∑–¥–∞–Ω–∏–µ–º, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏ —É–¥–∞–ª–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω –≤ –æ–¥–Ω–æ–º –∫–ª–∞—Å—Å–µ.

#### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

–ü–µ—Ä–≤—ã–º –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º —à–∞–≥–æ–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª—é–±–æ–≥–æ DAO-–∫–ª–∞—Å—Å–∞ (–≤–∫–ª—é—á–∞—è `UserDAO`) —è–≤–ª—è–µ—Ç—Å—è —É–∫–∞–∑–∞–Ω–∏–µ **ORM-–º–æ–¥–µ–ª–∏**, —Å –∫–æ—Ç–æ—Ä–æ–π –æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç `model`.

```python
# src/databases/dao/user_dao.py
from src.databases.dao.base import BaseDAO
from src.databases.sqlite.models import User # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º ORM-–º–æ–¥–µ–ª—å

class UserDAO(BaseDAO):
    # –£–∫–∞–∑—ã–≤–∞–µ–º, —Å –∫–∞–∫–æ–π –º–æ–¥–µ–ª—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ—Ç DAO
    model = User
    # –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ UserDAO –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –∫ —Ç–∞–±–ª–∏—Ü–µ, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –º–æ–¥–µ–ª—å—é User
```

#### –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç `BaseDAO`

–ë–ª–∞–≥–æ–¥–∞—Ä—è –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –æ—Ç `BaseDAO`, –∫–ª–∞—Å—Å `UserDAO` —Å—Ä–∞–∑—É –∂–µ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ **—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º –º–µ—Ç–æ–¥–∞–º**, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –≤ –±–∞–∑–æ–≤–æ–º –∫–ª–∞—Å—Å–µ. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –í—ã –º–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –º–µ—Ç–æ–¥ `add` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–µ —Ä–µ–∞–ª–∏–∑—É—è –µ–≥–æ –∑–∞–Ω–æ–≤–æ.

```python
# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞—Å–ª–µ–¥—É–µ–º–æ–≥–æ –º–µ—Ç–æ–¥–∞
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.schemas import UserCreateRequest # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Å—Ö–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞

@connection
async def create_new_user_handler(user_data: UserCreateRequest, session):
    # –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ add –∏–∑ BaseDAO —á–µ—Ä–µ–∑ UserDAO
    # BaseDAO.add —Å–æ–∑–¥–∞—Å—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä User, –¥–æ–±–∞–≤–∏—Ç –µ–≥–æ –≤ —Å–µ—Å—Å–∏—é –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç
    new_user = await UserDAO.add(session, **user_data.model_dump())
    return new_user.id
```

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤

–•–æ—Ç—è `BaseDAO` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—â–∏–µ –º–µ—Ç–æ–¥—ã, —á–∞—Å—Ç–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ **—É–Ω–∏–∫–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–µ**, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏ `User`. –ò–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞—é—Ç—Å—è **—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã** –≤–Ω—É—Ç—Ä–∏ `UserDAO`.

**–ü—Ä–∏–º–µ—Ä 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

```python
# src/databases/dao/user_dao.py
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from src.databases.dao.base import BaseDAO
from src.databases.sqlite.models import User
from src.databases.sqlite.schemas import UserResponse # Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

class UserDAO(BaseDAO):
    model = User

    @classmethod
    async def get_all_users(cls, session: AsyncSession) -> list[UserResponse]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Pydantic-—Å—Ö–µ–º—É.
        """
        query = select(cls.model) # SELECT * FROM users;
        result = await session.execute(query)
        records = result.scalars().all() # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–∫ –æ–±—ä–µ–∫—Ç—ã –º–æ–¥–µ–ª–∏ User
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ORM-–æ–±—ä–µ–∫—Ç—ã –≤ Pydantic-–æ–±—ä–µ–∫—Ç—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        return [UserResponse.from_orm(record) for record in records]
```

**–ü—Ä–∏–º–µ—Ä 2: –°–ª–æ–∂–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ—Ñ–∏–ª—è**

–ö–∞–∫ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å —Ä–∞–Ω–µ–µ, –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å *—Å–≤—è–∑–∞–Ω–Ω—ã–µ* –∑–∞–ø–∏—Å–∏ –≤ —Ä–∞–∑–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –≠—Ç–æ –∏–¥–µ–∞–ª—å–Ω—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –≤ `UserDAO`.

```python
# src/databases/dao/user_dao.py
from sqlalchemy.ext.asyncio import AsyncSession
from src.databases.dao.base import BaseDAO
from src.databases.sqlite.models import User, Profile # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ Profile –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
from src.databases.sqlite.schemas import UserCreateRequest # Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

class UserDAO(BaseDAO):
    model = User

    @classmethod
    async def add_user_with_profile(cls, session: AsyncSession, user_ UserCreateRequest, profile_ dict) -> User:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –Ω–µ–º—É –ø—Ä–æ—Ñ–∏–ª—å –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        - session: AsyncSession - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        - user_data: UserCreateRequest - Pydantic-—Å—Ö–µ–º–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        - profile_data: dict - —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è

        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        - User - –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        # 1. –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö Pydantic-—Å—Ö–µ–º—ã (–¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã)
        user = cls.model(
            username=user_data.username,
            email=user_data.email,
            # password_hash = hash_password(user_data.password) # –û–±—ã—á–Ω–æ –ø–∞—Ä–æ–ª—å —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
        )
        session.add(user)
        await session.flush()  # <-- –í–ê–ñ–ù–û: –ø–æ–ª—É—á–∞–µ–º user.id, –Ω–µ —Ñ–∏–∫—Å–∏—Ä—É—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

        # 2. –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å, –∏—Å–ø–æ–ª—å–∑—É—è ID —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        profile = Profile(
            user_id=user.id, # <-- –ó–¥–µ—Å—å –Ω—É–∂–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            bio=profile_data.get('bio'),
            # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è
        )
        session.add(profile)

        # 3. –û–¥–∏–Ω –∫–æ–º–º–∏—Ç –¥–ª—è –æ–±–µ–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        await session.commit()

        # 4. –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã)
        await session.refresh(user)

        return user  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

## üß± CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

CRUD ‚Äî —ç—Ç–æ –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞, –æ–±–æ–∑–Ω–∞—á–∞—é—â–∞—è **—á–µ—Ç—ã—Ä–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–∞–Ω–Ω—ã–º–∏: **Create (–°–æ–∑–¥–∞–Ω–∏–µ), Read (–ß—Ç–µ–Ω–∏–µ), Update (–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ), Delete (–£–¥–∞–ª–µ–Ω–∏–µ)**. SQLAlchemy –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ—â–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –í —à–∞–±–ª–æ–Ω–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–ø–∞—Ç—Ç–µ—Ä–Ω DAO**, –∫–æ—Ç–æ—Ä—ã–π **—Å–∫—Ä—ã–≤–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å** SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ **—É–ø—Ä–æ—â–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ** —Å ORM-–º–æ–¥–µ–ª—è–º–∏.

–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã –≤—Å–µ CRUD-–æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQLAlchemy –∏ DAO-–∫–ª–∞—Å—Å–æ–≤, –≤–∫–ª—é—á–∞—è —Ä–∞–±–æ—Ç—É —Å Pydantic-—Å—Ö–µ–º–∞–º–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö.

### üßÆ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Create)

–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ ORM-–º–æ–¥–µ–ª–µ–π. SQLAlchemy –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥—ã —Å–µ—Å—Å–∏–∏ `session.add()` –∏ `session.add_all()`. –í —à–∞–±–ª–æ–Ω–µ —ç—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ –º–µ—Ç–æ–¥–∞—Ö `BaseDAO`.

–î–ª—è **–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö** –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Pydantic-—Å—Ö–µ–º—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserCreateRequest`).

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è **–æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞** —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ `add()` –∏–∑ `BaseDAO` –∏–ª–∏ –µ–≥–æ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserDAO`), **–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤–∞–ª–∏–¥–∏—Ä—É—è –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Pydantic-—Å—Ö–µ–º—É**.

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.schemas import UserCreateRequest # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

@connection
async def create_user_endpoint(user_data: UserCreateRequest, session): # –ü—Ä–∏–Ω–∏–º–∞–µ–º Pydantic-—Å—Ö–µ–º—É
    # Pydantic —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
    # –ú–æ–∂–µ–º –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ user_data.username, user_data.email –∏ —Ç.–¥. —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –≤–∞–ª–∏–¥–Ω—ã
    user = await UserDAO.add(session, username=user_data.username, email=user_data.email)
    return user.id
```

`BaseDAO.add()` —Å–æ–∑–¥–∞—ë—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –º–æ–¥–µ–ª–∏, –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ —Å–µ—Å—Å–∏—é, —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç.

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤

–î–ª—è **–º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è** –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ `add_many()` –∏–∑ `BaseDAO`. –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Pydantic-—Å—Ö–µ–º, –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Ç–∞–∫–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ Pydantic-–æ–±—ä–µ–∫—Ç–æ–≤ –∏–ª–∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä–µ–π.

**–í–∞—Ä–∏–∞–Ω—Ç 1: –°–ø–∏—Å–æ–∫ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ `.model_dump()` –æ—Ç Pydantic-—Å—Ö–µ–º)**

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.schemas import UserCreateRequest # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

@connection
async def create_many_users_endpoint(users_data: list[UserCreateRequest], session): # –ü—Ä–∏–Ω–∏–º–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ö–µ–º
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ Pydantic-—Å—Ö–µ–º –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π –¥–ª—è BaseDAO.add_many
    users_dicts = [user_schema.model_dump() for user_schema in users_data]
    users = await UserDAO.add_many(session, users_dicts)
    return [u.id for u in users]
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä—è–º–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Å–ª–æ–≤–∞—Ä–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ FastAPI)**

–ï—Å–ª–∏ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `list[dict]`) –∏ —Ö–æ—Ç–∏—Ç–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Å–ª–æ–≤–∞—Ä—å, –≤—ã –º–æ–∂–µ—Ç–µ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `add_many`.

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.schemas import UserCreateRequest # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

@connection
async def create_many_users_endpoint_raw(users_raw_data: list[dict], session): # –ü—Ä–∏–Ω–∏–º–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π
    # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Å–ª–æ–≤–∞—Ä—å —á–µ—Ä–µ–∑ Pydantic
    validated_users_data = [UserCreateRequest(**user_dict) for user_dict in users_raw_data]
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è BaseDAO
    users_dicts = [user_schema.model_dump() for user_schema in validated_users_data]
    users = await UserDAO.add_many(session, users_dicts)
    return [u.id for u in users]
```

–ú–µ—Ç–æ–¥ `add_many()` –∏–∑ `BaseDAO` –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö –ø—Ä–∏–Ω–∏–º–∞–µ—Ç **—Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π**, –≥–¥–µ –∫–∞–∂–¥—ã–π —Å–ª–æ–≤–∞—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –º–æ–¥–µ–ª–∏.

#### –°–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü

–í —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö —á–∞—Å—Ç–æ –±—ã–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ **—Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π** –≤ —Ä–∞–∑–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∑–∞ **–æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é**. –î–ª—è —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞–µ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å **—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã** –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö DAO-–∫–ª–∞—Å—Å–∞—Ö.

–ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å **–∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `users`** –∏ **—Å–≤—è–∑–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `profiles`**. –≠—Ç–æ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –∫–ª–∞—Å—Å–µ `UserDAO` —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```python
# src/databases/dao/user_dao.py
from sqlalchemy.ext.asyncio import AsyncSession
from src.databases.dao.base import BaseDAO
from src.databases.sqlite.models import User, Profile # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ Profile —Ç–∞–∫–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
from src.databases.sqlite.schemas import UserCreateRequest # –ò—Å–ø–æ–ª—å–∑—É–µ–º Pydantic-—Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

class UserDAO(BaseDAO):
    model = User

    @classmethod
    async def add_user_with_profile(cls, session: AsyncSession, user_data: UserCreateRequest, profile_data: dict) -> User:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –Ω–µ–º—É –ø—Ä–æ—Ñ–∏–ª—å –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        - session: AsyncSession - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        - user_data: UserCreateRequest - Pydantic-—Å—Ö–µ–º–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        - profile_data: dict - —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è

        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        - User - –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        # 1. –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö Pydantic-—Å—Ö–µ–º—ã (–¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã)
        user = cls.model(
            username=user_data.username,
            email=user_data.email,
            # password_hash = hash_password(user_data.password) # –û–±—ã—á–Ω–æ –ø–∞—Ä–æ–ª—å —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
        )
        session.add(user)
        await session.flush()  # <-- –í–ê–ñ–ù–û: –ø–æ–ª—É—á–∞–µ–º user.id, –Ω–µ —Ñ–∏–∫—Å–∏—Ä—É—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

        # 2. –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å, –∏—Å–ø–æ–ª—å–∑—É—è ID —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        profile = Profile(
            user_id=user.id, # <-- –ó–¥–µ—Å—å –Ω—É–∂–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            bio=profile_data.get('bio'),
            # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è
        )
        session.add(profile)

        # 3. –û–¥–∏–Ω –∫–æ–º–º–∏—Ç –¥–ª—è –æ–±–µ–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        await session.commit()

        # 4. –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã)
        await session.refresh(user)

        return user  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

```{admonition} –°–æ–≤–µ—Ç: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
:class: tip
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Pydantic-—Å—Ö–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserCreateRequest`) –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∏ –Ω–∞–¥—ë–∂–Ω—ã–º.
```

–•–æ—Ä–æ—à–æ, –≤–æ—Ç —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö", –≥–¥–µ —Å–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è `select` –∏ `get`, –¥–µ–ª–∞–µ—Ç—Å—è —É–ø–æ—Ä –Ω–∞ `get` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ ID, –∏ –ø—Ä–∏–º–µ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å —É—á—ë—Ç–æ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ `get` –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `Pydantic`-—Å—Ö–µ–º.

---

### üìñ –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Read)

–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ SQLAlchemy –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤. –î–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞ –ø–æ–ª—É—á–µ–Ω–∏—è **–æ–¥–Ω–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏** –ø–æ –µ—ë **–ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É (–æ–±—ã—á–Ω–æ `id`)** ‚Äî —ç—Ç–æ `select()` –∏ `session.get()`. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π** –∏–ª–∏ **–∑–∞–ø–∏—Å–µ–π –ø–æ –¥—Ä—É–≥–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `select()`.

#### `session.get()` vs `select()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ ID

–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å **–æ–¥–Ω—É –∑–∞–ø–∏—Å—å –ø–æ –µ—ë —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É (ID)**, **`session.get()`** ‚Äî —ç—Ç–æ **–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –∏ –±–æ–ª–µ–µ —É–¥–æ–±–Ω—ã–π** —Å–ø–æ—Å–æ–± –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `select()`.

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | `session.get()` | `select()` (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ ID) |
| :--- | :--- | :--- |
| **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ** | –ü–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –ø–æ –ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É. | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è `SELECT` –∑–∞–ø—Ä–æ—Å–æ–≤. |
| **–£–¥–æ–±—Å—Ç–≤–æ** | **–ü—Ä–æ—â–µ –∏ –∫–æ—Ä–æ—á–µ**. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –º–æ–¥–µ–ª—å –∏ –∑–Ω–∞—á–µ–Ω–∏–µ `id`. | –¢—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è `select()` –∑–∞–ø—Ä–æ—Å–∞, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `.filter_by(id=id_value)`) –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (`.scalar_one_or_none()`). |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ**. SQLAlchemy –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—ç—à —Å–µ—Å—Å–∏–∏. | –°–æ–∑–¥–∞—ë—Ç SQL-–∑–∞–ø—Ä–æ—Å (`SELECT ... WHERE id = ?`) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –ë–î. |
| **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** | **–ù–∞–¥—ë–∂–Ω–µ–µ**. –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞. SQLAlchemy –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ –≤ `filter_by()` –∏–ª–∏ `where()`. |
| **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** | –°—Ç–∞–ª–∞ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π** –≤ SQLAlchemy 2.0+ (`await session.get(...)`). | –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å —Å `await session.execute(...)` –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ. |

–ú–µ—Ç–æ–¥ `select()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **–≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤** –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—è–º, –≤—ã–±–æ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, —Ä–∞–±–æ—Ç–∞ —Å –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏ –∏ —Ç.–¥.

–û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –í—ã–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–¥–Ω–æ–π –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
- –£–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è
- –ü—Ä–∏–º–µ–Ω—è—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã (`where`, `filter_by`), —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (`order_by`), –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ (`group_by`)
- –û–±—ä–µ–¥–∏–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é `JOIN`
- –†–∞–±–æ—Ç–∞—Ç—å —Å –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ ID (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `session.get()`)

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ –µ—ë –ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É (`id`) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `session.get()`, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ—â–µ, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ. –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –º–æ–∂–Ω–æ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `BaseDAO`.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `BaseDAO`:**

```python
# src/databases/dao/base.py
from sqlalchemy.ext.asyncio import AsyncSession

class BaseDAO:
    model = None

        # ... (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)

    @classmethod
    async def find_one_or_none_by_id(cls, session: AsyncSession, data_id: int):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –ø–æ –µ—ë ID –∏–ª–∏ None, –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç session.get() –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ –ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É.
        """
        return await session.get(cls.model, data_id)
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å Pydantic-—Å—Ö–µ–º–æ–π –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.schemas import UserResponse # –ò—Å–ø–æ–ª—å–∑—É–µ–º Pydantic-—Å—Ö–µ–º—É –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

@connection
async def get_user_by_id_endpoint(user_id: int, session: AsyncSession):
    user = await UserDAO.find_one_or_none_by_id(session, user_id)
    if user:
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ORM-–æ–±—ä–µ–∫—Ç –≤ Pydantic-—Å—Ö–µ–º—É –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        return UserResponse.from_orm(user) # Pydantic —Å–∞–º "–≤—ã—Ç–∞—â–∏—Ç" –Ω—É–∂–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
    return None # –∏–ª–∏ HTTP 404
```
#### –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π

**–ü—Ä–∏–º–µ—Ä: –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

```python
# src/databases/dao/user_dao.py
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from src.databases.dao.base import BaseDAO
from src.databases.sqlite.models import User
from src.databases.sqlite.schemas import UserResponse # –ò—Å–ø–æ–ª—å–∑—É–µ–º Pydantic-—Å—Ö–µ–º—É –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

class UserDAO(BaseDAO):
    model = User

    @classmethod
    async def get_all_users(cls, session: AsyncSession) -> list[UserResponse]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Pydantic-—Å—Ö–µ–º—É.
        """
        query = select(cls.model) # SELECT * FROM users;
        result = await session.execute(query)
        records = result.scalars().all() # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–∫ –æ–±—ä–µ–∫—Ç—ã –º–æ–¥–µ–ª–∏ User
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ORM-–æ–±—ä–µ–∫—Ç—ã –≤ Pydantic-–æ–±—ä–µ–∫—Ç—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        return [UserResponse.from_orm(record) for record in records]
```

#### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π** –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **—Ñ–∏–ª—å—Ç—Ä—ã** –≤ `select()`.

- `where()` ‚Äî –≥–∏–±–∫–∏–π –∏ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è **—Å–ª–æ–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π**.
- `filter_by()` ‚Äî –±–æ–ª–µ–µ **—É–¥–æ–±–Ω—ã–π –∏ –ø—Ä–æ—Å—Ç–æ–π** —Å–ø–æ—Å–æ–±, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ–ª–µ–π.

| –ú–µ—Ç–æ–¥ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å | –ü—Ä–∏–º–µ—Ä |
|-------|---------------------|--------|
| `where()` | –°–ª–æ–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã (`>`, `<`, `!=`, `like`, `in`) | `User.age > 18` |
| `filter_by()` | –ü—Ä–æ—Å—Ç—ã–µ —É—Å–ª–æ–≤–∏—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—è–º | `username="john_doe"` |

**–ü—Ä–∏–º–µ—Ä—ã:**

```python
from sqlalchemy import select
from src.databases.sqlite.models import User

# –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å—Ç–∞—Ä—à–µ 18 –ª–µ—Ç (where)
query = select(User).where(User.age > 18, User.is_active == True)

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏ (filter_by)
query = select(User).filter_by(username="john_doe")

# –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (filter_by)
query = select(User).filter_by(is_active=True)
```

#### –í—ã–±–æ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫

–ò–Ω–æ–≥–¥–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ **–Ω–µ –Ω—É–∂–Ω—ã –≤—Å–µ –ø–æ–ª—è** –º–æ–¥–µ–ª–∏. –ú–æ–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `select()`, —á—Ç–æ **–æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å** –∏ **—Å–æ–∫—Ä–∞—Ç–∏—Ç –æ–±—ä—ë–º –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö**. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —É–¥–æ–±–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é **—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Pydantic-—Å—Ö–µ–º**.

**–ü—Ä–∏–º–µ—Ä: –ø–æ–ª—É—á–µ–Ω–∏–µ ID –∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

```python
# src/databases/sqlite/schemas/user.py
from pydantic import BaseModel, ConfigDict

class UsernameIdResponse(BaseModel):
    """
    Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ —Å ID –∏ –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    id: int
    username: str

    model_config = ConfigDict(
        from_attributes=True, # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å .from_orm() –∏ —Å –∫–æ—Ä—Ç–µ–∂–∞–º–∏/—Å–ª–æ–≤–∞—Ä—è–º–∏
    )
```

```python
# src/databases/dao/user_dao.py
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from src.databases.dao.base import BaseDAO
from src.databases.sqlite.models import User
from src.databases.sqlite.schemas.user import UsernameIdResponse

class UserDAO(BaseDAO):
    model = User

    @classmethod
    async def get_username_id(cls, session: AsyncSession) -> list[UsernameIdResponse]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ Pydantic-–æ–±—ä–µ–∫—Ç–æ–≤ UsernameIdResponse (id, username).
        """
        query = select(cls.model.id, cls.model.username) # SELECT id, username FROM users;
        result = await session.execute(query)
        records = result.all() # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç [(id1, username1), (id2, username2), ...]
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ—Ä—Ç–µ–∂–∏ –≤ Pydantic-–æ–±—ä–µ–∫—Ç—ã
        return [UsernameIdResponse(id=record[0], username=record[1]) for record in records]
```

#### –ü–æ–¥–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–û—Ç–Ω–æ—à–µ–Ω–∏—è) (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `select()` –∏ `options()`)

–ö–æ–≥–¥–∞ —É –≤–∞—Å –µ—Å—Ç—å **—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `User` –∏ `Profile`), SQLAlchemy –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ **–ª–µ–Ω–∏–≤–æ** (lazy loading). –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–µ **"N+1 –∑–∞–ø—Ä–æ—Å–æ–≤"**, –∫–æ–≥–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è N –æ–±—ä–µ–∫—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è N –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

SQLAlchemy –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–¥–≥—Ä—É–∑–∫–∏**, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã:

- `joinedload()` ‚Äî –ø–æ–¥–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ `LEFT OUTER JOIN`.
- `selectinload()` ‚Äî –ø–æ–¥–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å `IN`. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö.
- `subqueryload()` ‚Äî –ø–æ–¥–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å.

**–ü—Ä–∏–º–µ—Ä —Å `selectinload` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ —Å –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏):**

```python
# src/databases/dao/user_dao.py
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload
from src.databases.dao.base import BaseDAO
from src.databases.sqlite.models import User
from src.databases.sqlite.schemas import UserResponse # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ UserResponse –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å

class UserDAO(BaseDAO):
    model = User

    @classmethod
    async def get_users_with_profiles(cls, session: AsyncSession) -> list[UserResponse]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Ö –ø—Ä–æ—Ñ–∏–ª—è–º–∏, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –∑–∞ –æ–¥–∏–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å.
        """
        query = select(cls.model).options(selectinload(User.profile)) # –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        result = await session.execute(query)
        users = result.scalars().all()
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ORM-–æ–±—ä–µ–∫—Ç—ã (—Å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è–º–∏) –≤ Pydantic-–æ–±—ä–µ–∫—Ç—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        return [UserResponse.from_orm(user) for user in users]
```

```{admonition} –°–æ–≤–µ—Ç: –ò–∑–±–µ–≥–∞–π—Ç–µ N+1
:class: tip
–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–¥–≥—Ä—É–∑–∫–∏ (`selectinload`, `joinedload`) –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –≤—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
```

### üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Update)

SQLAlchemy –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–∞** –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞** ‚Äî —á–µ—Ä–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ ORM-–æ–±—ä–µ–∫—Ç–∞ (–ø–∞—Ç—Ç–µ—Ä–Ω Unit of Work).
- **–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** ‚Äî —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π SQL-–∑–∞–ø—Ä–æ—Å `UPDATE`.

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞

–≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–ø–∞—Ç—Ç–µ—Ä–Ω Unit of Work**, –≤ –∫–æ—Ç–æ—Ä–æ–º SQLAlchemy **–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤ –æ–±—ä–µ–∫—Ç–∞—Ö –∏ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å—ã** –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ. –û–Ω —É–¥–æ–±–µ–Ω –¥–ª—è **–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞**, –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

**–ü—Ä–∏–º–µ—Ä: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—Ä—É—á–Ω—É—é)**

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.models import User # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å

@connection
async def update_user_name_manual(user_id: int, new_username: str, session):
    # 1. –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    user = await session.get(User, user_id) # <-- –ü–æ–ª—É—á–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é
    if user:
        # 2. –ò–∑–º–µ–Ω—è–µ–º –∞—Ç—Ä–∏–±—É—Ç
        user.username = new_username
        # 3. –ò–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º @connection –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
    return user
```

**–ü—Ä–∏–º–µ—Ä: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `BaseDAO` –∏ Pydantic-—Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)**

–î–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `update_one_by_id` –≤ `BaseDAO`, –ø—Ä–∏–Ω–∏–º–∞—é—â–∏–π Pydantic-—Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–∑–º–µ–Ω—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

**–°–æ–∑–¥–∞–Ω–∏–µ Pydantic-—Å—Ö–µ–º—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

```python
# src/databases/sqlite/schemas/user.py
from pydantic import BaseModel, ConfigDict, EmailStr
from typing import Optional # –ò—Å–ø–æ–ª—å–∑—É–µ–º Optional –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π

class UserUpdateRequest(BaseModel):
    """
    Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –í—Å–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–æ–≥—É—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –Ω–µ –≤—Å–µ –ø–æ–ª—è.
    """
    username: Optional[str] = None
    email: Optional[EmailStr] = None
    # password –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ —Å—é–¥–∞, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç

    model_config = ConfigDict(
        from_attributes=True, # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å .from_orm(), –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    )
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `BaseDAO`:**

```python
# src/databases/dao/base.py (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π BaseDAO)
from pydantic import BaseModel
from sqlalchemy.exc import SQLAlchemyError
from sqlalchemy.ext.asyncio import AsyncSession

class BaseDAO:
    model = None

    # ... (model, add, add_many, find_one_or_none_by_id)

    @classmethod
    async def update_one_by_id(cls, session: AsyncSession, data_id: int, values: BaseModel):
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –ø–æ ID —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Pydantic-—Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
        """
        values_dict = values.model_dump(exclude_unset=True) # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è –∏–∑ —Å—Ö–µ–º—ã
        try:
            record = await session.get(cls.model, data_id)
            if record:
                for key, value in values_dict.items():
                    setattr(record, key, value) # –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã ORM-–æ–±—ä–µ–∫—Ç–∞
                await session.flush() # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –ë–î
            return record
        except SQLAlchemyError as e:
            await session.rollback() # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
            raise e
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.schemas import UserUpdateRequest # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Pydantic-—Å—Ö–µ–º—É

@connection
async def update_user_via_dao(user_id: int, update_data: UserUpdateRequest, session):
    # Pydantic-—Å—Ö–µ–º–∞ update_data —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    updated_user = await UserDAO.update_one_by_id(
        session=session,
        data_id=user_id,
        values=update_data # –ü–µ—Ä–µ–¥–∞—ë–º –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Pydantic-–æ–±—ä–µ–∫—Ç
    )
    return updated_user
```

#### –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `update()`

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ **–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã –≤ –ø–∞–º—è—Ç—å**, –∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç **–ø—Ä—è–º–æ–π SQL-–∑–∞–ø—Ä–æ—Å `UPDATE`**, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ **—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ** –ø—Ä–∏ **–º–∞—Å—Å–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö**.

**–ü—Ä–∏–º–µ—Ä: –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ —É—Å–ª–æ–≤–∏—é (–≤—Ä—É—á–Ω—É—é)**

```python
from sqlalchemy import update
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.models import User

@connection
async def update_users_by_age_manual(min_age: int, new_status: str, session: AsyncSession):
    stmt = (
        update(User)
        .where(User.age >= min_age) # –£—Å–ª–æ–≤–∏–µ WHERE
        .values(status=new_status)   # –ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    )
    result = await session.execute(stmt)
    return result.rowcount  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
```

**–ü—Ä–∏–º–µ—Ä: –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `BaseDAO` –∏ Pydantic-—Å—Ö–µ–º –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏–π)**

–î–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ `BaseDAO`, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π Pydantic-—Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–∞–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤, —Ç–∞–∫ –∏ –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.

**–°–æ–∑–¥–∞–Ω–∏–µ Pydantic-—Å—Ö–µ–º –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏–π (–ø—Ä–∏–º–µ—Ä):**

–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ö–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `UserUpdateRequest` –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π) –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, `UserFilterSchema`.

```python
# src/databases/sqlite/schemas/user.py
from pydantic import BaseModel, ConfigDict, EmailStr
from typing import Optional

# ... (UserUpdateRequest –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

class UserFilterSchema(BaseModel):
    """
    Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    """
    username: Optional[str] = None
    email: Optional[EmailStr] = None
    is_active: Optional[bool] = None

    model_config = ConfigDict(
        from_attributes=True,
    )
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `BaseDAO`:**

```python
# src/databases/dao/base.py (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π BaseDAO)
from pydantic import BaseModel
from sqlalchemy import update
from sqlalchemy.exc import SQLAlchemyError
from sqlalchemy.ext.asyncio import AsyncSession

class BaseDAO:
    # ... (model, add, add_many, find_one_or_none_by_id, update_one_by_id)

    @classmethod
    async def update_many_by_filter(cls, session: AsyncSession, filter_criteria: BaseModel, values: BaseModel):
        """
        –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø–æ —Ñ–∏–ª—å—Ç—Ä—É, –∏—Å–ø–æ–ª—å–∑—É—è Pydantic-—Å—Ö–µ–º—ã.
        """
        filter_dict = filter_criteria.model_dump(exclude_unset=True) # –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        values_dict = values.model_dump(exclude_unset=True)         # –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        try:
            stmt = (
                update(cls.model)
                .filter_by(**filter_dict) # <-- Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (WHERE)
                .values(**values_dict)    # <-- Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (SET)
            )
            result = await session.execute(stmt)
            await session.flush()
            return result.rowcount
        except SQLAlchemyError as e:
            await session.rollback()
            raise e
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.schemas import UserUpdateRequest, UserFilterSchema

@connection
async def mass_update_users_via_dao(session):
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º —Ñ–∏–ª—å—Ç—Ä
    filter_schema = UserFilterSchema(username="old_name") # –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ—Ö —Å username="old_name"
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    values_schema = UserUpdateRequest(username="new_name") # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å username="new_name"

    updated_count = await UserDAO.update_many_by_filter(
        session=session,
        filter_criteria=filter_schema, # –ü–µ—Ä–µ–¥–∞—ë–º —Å—Ö–µ–º—É —Ñ–∏–ª—å—Ç—Ä–∞
        values=values_schema           # –ü–µ—Ä–µ–¥–∞—ë–º —Å—Ö–µ–º—É –∑–Ω–∞—á–µ–Ω–∏–π
    )
    print(f'–û–±–Ω–æ–≤–ª–µ–Ω–æ {updated_count} –∑–∞–ø–∏—Å–µ–π')
    return updated_count
```

### üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (Delete)

SQLAlchemy –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–∞** –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:

- **–û–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥** ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç, –∑–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º –µ–≥–æ.
- **–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** ‚Äî –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–∞–º—è—Ç—å.

#### –£–¥–∞–ª–µ–Ω–∏–µ –≤ —Å—Ç–∏–ª–µ –û–û–ü

–ü—Ä–∏ —ç—Ç–æ–º –ø–æ–¥—Ö–æ–¥–µ **—Å–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞—é—Ç –æ–±—ä–µ–∫—Ç** –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∞ –∑–∞—Ç–µ–º **—É–¥–∞–ª—è—é—Ç –µ–≥–æ** —Å –ø–æ–º–æ—â—å—é `session.delete()`. –≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± —É–¥–æ–±–µ–Ω –¥–ª—è **—É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞**, –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –ø–æ ID –∏–ª–∏ –¥—Ä—É–≥–æ–º—É —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é.

**–ü—Ä–∏–º–µ—Ä: —É–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø–æ ID (–≤—Ä—É—á–Ω—É—é)**

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.models import User # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å

@connection
async def delete_user_by_id_manual(user_id: int, session: AsyncSession):
    user = await session.get(User, user_id) # <-- –ü–æ–ª—É—á–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é
    if user:
        await session.delete(user) # –ü–æ–º–µ—á–∞–µ–º –æ–±—ä–µ–∫—Ç –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–π
    # session.commit() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ @connection
    return user
```

**–ü—Ä–∏–º–µ—Ä: —É–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø–æ ID (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `BaseDAO`)**

–î–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ `delete_one_by_id` –≤ `BaseDAO`.

```python
# src/databases/dao/base.py (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π BaseDAO)
from sqlalchemy.exc import SQLAlchemyError
from sqlalchemy.ext.asyncio import AsyncSession

class BaseDAO:
    # ... (model, add, add_many, find_one_or_none_by_id, update_one_by_id, update_many_by_filter)

    @classmethod
    async def delete_one_by_id(cls, session: AsyncSession, data_id: int):
        """
        –£–¥–∞–ª—è–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –ø–æ ID.
        """
        try:
            data = await session.get(cls.model, data_id) # <-- –ò—Å–ø–æ–ª—å–∑—É–µ–º session.get
            if data:
                await session.delete(data)
                await session.flush()
            return data
        except SQLAlchemyError as e:
            await session.rollback()
            raise e
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection

@connection
async def delete_user_via_dao(user_id: int, session: AsyncSession):
    deleted_user = await UserDAO.delete_one_by_id(session, user_id)
    return deleted_user # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–¥–∞–ª—ë–Ω–Ω—ã–π ORM-–æ–±—ä–µ–∫—Ç –∏–ª–∏ None
```

#### –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `delete()`

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ **–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã –≤ –ø–∞–º—è—Ç—å**, –∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç **–ø—Ä—è–º–æ–π SQL-–∑–∞–ø—Ä–æ—Å `DELETE`**, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ **—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ** –ø—Ä–∏ **–º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏**.

**–ü—Ä–∏–º–µ—Ä: –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ —É—Å–ª–æ–≤–∏—é (–≤—Ä—É—á–Ω—É—é)**

```python
from sqlalchemy import delete
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.models import User

@connection
async def delete_users_by_age_manual(min_age: int, session: AsyncSession):
    stmt = delete(User).where(User.age >= min_age) # –£—Å–ª–æ–≤–∏–µ WHERE
    result = await session.execute(stmt)
    return result.rowcount  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
```

#### –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —É–¥–∞–ª–µ–Ω–∏—è –≤ `BaseDAO`

–î–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —É–¥–∞–ª–µ–Ω–∏—è –≤ `BaseDAO`.

**–ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Pydantic-—Å—Ö–µ–º—ã)**

–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π Pydantic-—Å—Ö–µ–º—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–¥–∞—á–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

**–°–æ–∑–¥–∞–Ω–∏–µ Pydantic-—Å—Ö–µ–º—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–ø—Ä–∏–º–µ—Ä):**

```python
# src/databases/sqlite/schemas/user.py
from pydantic import BaseModel, ConfigDict, EmailStr
from typing import Optional

# ... (UserUpdateRequest, UsernameIdResponse –∫–∞–∫ —Ä–∞–Ω—å—à–µ)

class UserFilterSchema(BaseModel):
    """
    Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    """
    username: Optional[str] = None
    email: Optional[EmailStr] = None
    is_active: Optional[bool] = None

    model_config = ConfigDict(
        from_attributes=True,
    )
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `BaseDAO`:**

```python
# src/databases/dao/base.py (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π BaseDAO)
from pydantic import BaseModel
from sqlalchemy import delete
from sqlalchemy.exc import SQLAlchemyError
from sqlalchemy.ext.asyncio import AsyncSession

class BaseDAO:
    # ... (model, add, add_many, find_one_or_none_by_id, update_one_by_id, update_many_by_filter, delete_one_by_id)

    @classmethod
    async def delete_many_by_filter(cls, session: AsyncSession, filters: BaseModel | None):
        """
        –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø–æ —Ñ–∏–ª—å—Ç—Ä—É, –∏—Å–ø–æ–ª—å–∑—É—è Pydantic-—Å—Ö–µ–º—É.
        –ï—Å–ª–∏ filters=None, —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!).
        """
        if filters:
            filter_dict = filters.model_dump(exclude_unset=True) # –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ —Å—Ö–µ–º—ã
            stmt = delete(cls.model).filter_by(**filter_dict) # <-- Pydantic-—Å—Ö–µ–º–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (WHERE)
        else:
            stmt = delete(cls.model) # –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö
        try:
            result = await session.execute(stmt)
            await session.flush()
            return result.rowcount
        except SQLAlchemyError as e:
            await session.rollback()
            raise e

    @classmethod
    async def delete_many_by_ids(cls, session: AsyncSession, ids: list[int]):
        """
        –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø–æ —Å–ø–∏—Å–∫—É ID.
        """
        if not ids:
            return 0
        stmt = delete(cls.model).where(cls.model.id.in_(ids)) # –£—Å–ª–æ–≤–∏–µ WHERE id IN (...)
        try:
            result = await session.execute(stmt)
            await session.flush()
            return result.rowcount
        except SQLAlchemyError as e:
            await session.rollback()
            raise e
```

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```python
from src.databases.dao.user_dao import UserDAO
from src.databases.sqlite.core import connection
from src.databases.sqlite.schemas import UserFilterSchema

@connection
async def mass_delete_users_by_filter(session):
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º —Ñ–∏–ª—å—Ç—Ä
    filter_schema = UserFilterSchema(is_active=False) # –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

    deleted_count = await UserDAO.delete_many_by_filter(
        session=session,
        filters=filter_schema # –ü–µ—Ä–µ–¥–∞—ë–º —Å—Ö–µ–º—É —Ñ–∏–ª—å—Ç—Ä–∞
    )
    print(f'–£–¥–∞–ª–µ–Ω–æ {deleted_count} –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')
    return deleted_count

@connection
async def mass_delete_users_by_ids(user_ids_to_delete: list[int], session):
    deleted_count = await UserDAO.delete_many_by_ids(
        session=session,
        ids=user_ids_to_delete # –ü–µ—Ä–µ–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ ID
    )
    print(f'–£–¥–∞–ª–µ–Ω–æ {deleted_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ ID')
    return deleted_count
```

```{admonition} –í–∞–∂–Ω–æ
:class: warning
–ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –º–µ—Ç–æ–¥–æ–º `delete_many_by_filter`, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—ë—Ç–µ `filters=None` ‚Äî –æ–Ω —É–¥–∞–ª–∏—Ç **–≤—Å–µ –∑–∞–ø–∏—Å–∏** –≤ —Ç–∞–±–ª–∏—Ü–µ.
```

–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π —É–ª—É—á—à–∏–º —Ä–∞–∑–¥–µ–ª "Alembic", —Å–¥–µ–ª–∞–≤ –µ–≥–æ –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, –ø–æ–Ω—è—Ç–Ω—ã–º –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å —Ç–µ–º, —á—Ç–æ —É–∂–µ –æ–ø–∏—Å–∞–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. –í–æ—Ç —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:

1.  **–î–æ–±–∞–≤–∏—Ç—å –≤–≤–µ–¥–µ–Ω–∏–µ:** –û–±—ä—è—Å–Ω–∏—Ç—å, *—á—Ç–æ —Ç–∞–∫–æ–µ* Alembic –∏ *–∑–∞—á–µ–º* –æ–Ω –Ω—É–∂–µ–Ω –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ SQLAlchemy –∏ ORM-–º–æ–¥–µ–ª–µ–π.
2.  **–£—Ç–æ—á–Ω–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:** –£–∫–∞–∑–∞—Ç—å, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ `alembic init -t async alembic` —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω–µ, –∏ –æ–ø–∏—Å–∞—Ç—å, *—á—Ç–æ* –æ–Ω–∞ –¥–µ–ª–∞–µ—Ç *–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ* –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —à–∞–±–ª–æ–Ω–∞ (–ø–∞–ø–∫–∞ `alembic/`, `alembic.ini`).
3.  **–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É `env.py`:** –û–±—ä—è—Å–Ω–∏—Ç—å, *–∑–∞—á–µ–º* –Ω—É–∂–Ω—ã –∏–º–ø–æ—Ä—Ç—ã –º–æ–¥–µ–ª–µ–π (—á—Ç–æ–±—ã Alembic "–≤–∏–¥–µ–ª" –∏—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ), –∏ *–∫–∞–∫ –∏–º–µ–Ω–Ω–æ* –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `configs.settings`.
4.  **–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:** –û–±—ä—è—Å–Ω–∏—Ç—å, *–∫–∞–∫* –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–∏–º–µ–Ω—è—Ç—å, –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏, –∏ *–∫–æ–≥–¥–∞* —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å (–ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π).
5.  **–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª –ø—Ä–æ `alembic.ini`:** –£–ø–æ–º—è–Ω—É—Ç—å, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `env.py`, –Ω–æ `alembic.ini` —Å–æ–¥–µ—Ä–∂–∏—Ç –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ –∫—Ä–∞—Ç–∫–æ).
6.  **–°–≤—è–∑–∞—Ç—å —Å ORM-–º–æ–¥–µ–ª—è–º–∏:** –ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è *–Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ ORM-–º–æ–¥–µ–ª—è—Ö*.
7.  **–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–æ–Ω–∏—Ü–∏–∏:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `seealso`, `warning`, `tip` –¥–ª—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

–í–æ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª:

---

## üß≠ Alembic: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

Alembic ‚Äî —ç—Ç–æ **–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**, **–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å SQLAlchemy**. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç **—É–ø—Ä–∞–≤–ª—è—Ç—å –≤–µ—Ä—Å–∏—è–º–∏ —Å—Ö–µ–º—ã**, **–æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤ ORM-–º–æ–¥–µ–ª—è—Ö –∏ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å** SQL-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∏–ª–∏ –æ—Ç–∫–∞—Ç–∞) —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–æ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ** –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, —á—Ç–æ–±—ã **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å** –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ —Å —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ë–î.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Alembic:**

- **–ö–æ–Ω—Ç—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π:** –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –≤–∏–¥–µ –º–∏–≥—Ä–∞—Ü–∏–∏.
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.
- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ö–µ–º—ã.

### üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Alembic (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω–µ)

–í —à–∞–±–ª–æ–Ω–µ Alembic —É–∂–µ **–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω** –∫–æ–º–∞–Ω–¥–æ–π `alembic init -t async alembic`. –≠—Ç–æ —Å–æ–∑–¥–∞–ª–æ:

- –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `alembic/` ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –∏ —à–∞–±–ª–æ–Ω —Å–∫—Ä–∏–ø—Ç–æ–≤.
- –§–∞–π–ª `alembic.ini` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic (—á–∞—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ `env.py`).
- –§–∞–π–ª `alembic/env.py` ‚Äî —Ç–æ—á–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å ORM-–º–æ–¥–µ–ª—è–º–∏.

### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `alembic/env.py`

–§–∞–π–ª `alembic/env.py` ‚Äî **–∫–ª—é—á–µ–≤–æ–π** –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Alembic —Å –≤–∞—à–∏–º –ø—Ä–æ–µ–∫—Ç–æ–º SQLAlchemy. –û–Ω —É–∫–∞–∑—ã–≤–∞–µ—Ç Alembic, **—Å –∫–∞–∫–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏** —Ä–∞–±–æ—Ç–∞—Ç—å –∏ **–∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è** –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

```{eval-rst}
.. toggle:: –ü–æ–∫–∞–∑–∞—Ç—å

   .. literalinclude:: ../alembic/env.py
      :language: python
      :caption: alembic/env.py
```

#### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ORM-–º–æ–¥–µ–ª–µ–π

Alembic –¥–æ–ª–∂–µ–Ω **–∑–Ω–∞—Ç—å** –æ –≤–∞—à–∏—Ö ORM-–º–æ–¥–µ–ª—è—Ö, —á—Ç–æ–±—ã **–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –î–ª—è —ç—Ç–æ–≥–æ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ **–≤—Å–µ** —Å–≤–æ–∏ –º–æ–¥–µ–ª–∏ –∏ **–±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å `Base`** –≤ `alembic/env.py`.

```python
# alembic/env.py
from logging.config import fileConfig

from sqlalchemy import engine_from_config
from sqlalchemy import pool

from alembic import context

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Base –∏ –≤—Å–µ –º–æ–¥–µ–ª–∏
from src.databases.sqlite.models.base import Base # <-- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
from src.databases.sqlite.models.user import User  # <-- –ü—Ä–∏–º–µ—Ä –º–æ–¥–µ–ª–∏
# from src.databases.sqlite.models.post import Post  # <-- –î–æ–±–∞–≤–ª—è–π—Ç–µ –¥—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏ –ø–æ –º–µ—Ä–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è
# from src.databases.sqlite.models.comment import Comment # <-- –∏ —Ç.–¥.

# this is the Alembic Config object
config = context.config

# Interpret the config file for Python logging.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# –£–∫–∞–∑—ã–≤–∞–µ–º Alembic, –∫–∞–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
target_metadata = Base.metadata # <-- –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π, –Ω–∞—Å–ª–µ–¥—É—é—â–∏—Ö—Å—è –æ—Ç Base

def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata, # <-- –ü–µ—Ä–µ–¥–∞—ë–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection, target_metadata=target_metadata # <-- –ü–µ—Ä–µ–¥–∞—ë–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

```{admonition} –í–∞–∂–Ω–æ: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
:class: warning
–ü–æ—Å–ª–µ **—Å–æ–∑–¥–∞–Ω–∏—è** –Ω–æ–≤–æ–π ORM-–º–æ–¥–µ–ª–∏ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –¥–æ–±–∞–≤—å—Ç–µ –µ—ë –∏–º–ø–æ—Ä—Ç –≤ `alembic/env.py`, —á—Ç–æ–±—ã Alembic –º–æ–≥ –µ—ë "—É–≤–∏–¥–µ—Ç—å" –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π.
```

#### 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î

Alembic –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å, **–∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è** –∫ –≤–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –í —à–∞–±–ª–æ–Ω–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `configs.settings`. –ù—É–∂–Ω–æ **—É–∫–∞–∑–∞—Ç—å** Alembic –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å URL –∏–∑ —ç—Ç–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.

–û–±—ã—á–Ω–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ `alembic.ini`, –Ω–æ –≤ `env.py` –º–æ–∂–Ω–æ **–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å** –∏–ª–∏ **—É–∫–∞–∑–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏**:

```python
# alembic/env.py (—Ñ—Ä–∞–≥–º–µ–Ω—Ç, –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π run_migrations_online/run_migrations_offline)
# ...
from configs.settings import settings # <-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    # –ü–æ–ª—É—á–∞–µ–º URL –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    alembic_config = config.get_section(config.config_ini_section)
    alembic_config['sqlalchemy.url'] = settings.database.sqlite.database_url # <-- –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º URL –∏–∑ settings

    connectable = engine_from_config(
        alembic_config, # <-- –ü–µ—Ä–µ–¥–∞—ë–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
        prefix="",
        poolclass=pool.NullPool,
    )
    # ...
```

–ò–ª–∏, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ, –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å URL –Ω–∞–ø—Ä—è–º—É—é –≤ `config.set_main_option` –≤ `run_migrations_offline`:

```python
# alembic/env.py (—Ñ—Ä–∞–≥–º–µ–Ω—Ç, –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ run_migrations_offline)
from configs.settings import settings # <-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    # url = config.get_main_option("sqlalchemy.url")
    url = settings.database.sqlite.database_url # <-- –ü–æ–ª—É—á–∞–µ–º URL –∏–∑ settings
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )
    # ...
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –≤ `.env` —Ñ–∞–π–ª–µ (–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –≤ `settings`) –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.

### üîÑ –†–∞–±–æ—Ç–∞ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

–ü–æ—Å–ª–µ **–∏–∑–º–µ–Ω–µ–Ω–∏—è** ORM-–º–æ–¥–µ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –∏–ª–∏ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏) **–≤—Å–µ–≥–¥–∞** –Ω—É–∂–Ω–æ **—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å** –∏ **–ø—Ä–∏–º–µ–Ω–∏—Ç—å** –º–∏–≥—Ä–∞—Ü–∏—é.

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

–°–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ–ª—è—Ö:

```bash
alembic revision --autogenerate -m "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, Add Post model)"
```

Alembic –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–µ –º–æ–¥–µ–ª–∏ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π SQL-—Å–∫—Ä–∏–ø—Ç –≤ `alembic/versions/`.

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–∏–º–µ–Ω—è–µ—Ç **–≤—Å–µ** –Ω–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```bash
alembic upgrade head
```

–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è **–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π** –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
alembic upgrade <revision_id>
```

#### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

–û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç **–ø–æ—Å–ª–µ–¥–Ω—é—é** –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é:

```bash
alembic downgrade -1
```

–î–ª—è –æ—Ç–∫–∞—Ç–∞ **–¥–æ** –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏:

```bash
alembic downgrade <revision_id>
```

```{admonition} –°–æ–≤–µ—Ç: –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
:class: tip
–í—Å–µ–≥–¥–∞ **–ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ** —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –ø–µ—Ä–µ–¥ –∏—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º. Alembic –º–æ–∂–µ—Ç –Ω–µ –≤—Å–µ–≥–¥–∞ —É–≥–∞–¥–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏). –ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ **—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å** —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é.
```

```{admonition} –í–∞–∂–Ω–æ: ENUM –∏ SQLite
:class: warning
–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–∏–ø `ENUM` –∏ **SQLite**, —É—á—Ç–∏—Ç–µ, —á—Ç–æ SQLite –µ–≥–æ **–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç** –Ω–∞–ø—Ä—è–º—É—é. Alembic –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è `ENUM`, –Ω–æ –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∏–ª–∏ –≤–µ—Å—Ç–∏ —Å–µ–±—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `String` –∏–ª–∏ `Integer` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –¢–∞–∫–∂–µ **–Ω–µ –∑–∞–±—ã–≤–∞–π—Ç–µ —É–¥–∞–ª—è—Ç—å** —Ç–∏–ø `ENUM` –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è.
```