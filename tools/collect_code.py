"""
–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É Tkinter –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è
–¥–µ—Ä–µ–≤–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
---------------------
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏ —Ñ–∞–π–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, __pycache__, .pyc).
- –í—ã–±–æ—Ä –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–º–æ—â—å—é –∫–ª–∏–∫–∞.
- –°–±–æ—Ä –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è.
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ä–µ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞.
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ä–µ–≤–∞ + —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ –ø–∞–ø–∫–∏ notes (–µ—Å–ª–∏ –µ—Å—Ç—å).
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∏—è/–∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ –≤ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ.
- –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –≥–∞–ª–æ—á–∫–∏" –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤.
- –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –¥–µ—Ä–µ–≤–æ" –¥–ª—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –¥–µ—Ä–µ–≤–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å Git Bash –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –≤ VS Code
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π `python tools/collect_code.py &`
3. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞"
"""

# TODO: —Å–¥–µ–ª–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –∫—Ä–∞—Å–∏–≤–µ–µ –∏ —É–¥–æ–±–Ω–µ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å

import os
import tkinter as tk
from tkinter import ttk

# –ü–∞–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
IGNORE_FOLDERS = {
    ".git",
    "__pycache__",
    ".venv",
    "venv",
    "_build",  # –ø–∞–ø–∫–∞ —Å–±–æ—Ä–∫–∏ Sphinx
    # "_static",  # –°—Ç–∏–ª–∏ Sphinx
    # "_templates",  # –®–∞–±–ª–æ–Ω—ã Sphinx
    ".ruff_cache",
    "docs/_build",
}

# –§–∞–π–ª—ã –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
IGNORE_FILES = {
    ".DS_Store",
    ".pyc",  # –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Python-—Ñ–∞–π–ª—ã
    ".pyo",
    ".pyd",
    ".mo",
    ".log",
    ".tmp",
    "~",  # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
}


def should_ignore(name, is_dir):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏ –≤—ã–≤–æ–¥–µ.

    Args:
        name (str): –ò–º—è —Ñ–∞–π–ª–∞ –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
        is_dir (bool): –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π.

    Returns:
        bool: True –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω—É–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å, False –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≤ –≤—ã–≤–æ–¥.
    """
    if is_dir:
        return name in IGNORE_FOLDERS
    else:
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
        if name in IGNORE_FILES:
            return True
        _, ext = os.path.splitext(name)
        return ext in IGNORE_FILES or name.startswith(".")


def get_tree_structure(start_path, prefix=""):
    """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏ ASCII-–¥–µ—Ä–µ–≤–∞.

    Args:
        start_path (str): –ü—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞.
        prefix (str): –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –æ—Ç—Å—Ç—É–ø–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö).

    Returns:
        str: –°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
    """
    try:
        entries = sorted(os.listdir(start_path))
    except PermissionError:
        return f"{prefix}‚îî‚îÄ‚îÄ [–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞]\n"

    output_lines = []
    filtered_entries = []
    for entry in entries:
        full_path = os.path.join(start_path, entry)
        is_dir = os.path.isdir(full_path)
        if not should_ignore(entry, is_dir):
            filtered_entries.append((entry, is_dir))

    for i, (entry, is_dir) in enumerate(filtered_entries):
        path = os.path.join(start_path, entry)
        is_last = i == len(filtered_entries) - 1

        connector = "‚îî‚îÄ‚îÄ " if is_last else "‚îú‚îÄ‚îÄ "
        line = f"{prefix}{connector}{entry}" + ("/" if is_dir else "")
        output_lines.append(line)

        if is_dir:
            new_prefix = "    " if is_last else "‚îÇ   "
            subdir_output = get_tree_structure(path, prefix + new_prefix)
            # –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–æ–≤
            output_lines.append(subdir_output.rstrip())

    return "\n".join(output_lines) + "\n"


# === –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===


class CodeCollectorApp:
    """
    GUI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Tkinter –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ —Ñ–∞–π–ª–æ–≤.
    """

    def __init__(self, root, project_path="."):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

        :param root: –∫–æ—Ä–Ω–µ–≤–æ–π –æ–±—ä–µ–∫—Ç Tkinter
        :param project_path: –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ç–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è)
        """
        self.root = root
        self.project_path = project_path
        self.selected_files = set()  # –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        self.tree_items = {}  # —Å–ª–æ–≤–∞—Ä—å: item_id -> {'path', 'type'}
        self.prompts = {}  # —Å–ª–æ–≤–∞—Ä—å: –∏–º—è_—Ñ–∞–π–ª–∞ -> –ø—É—Ç—å
        self.setup_prompts()  # –∏—â–µ–º –ø—Ä–æ–º–ø—Ç—ã
        self.setup_ui()

    def setup_prompts(self):
        """
        –°–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–∞–ø–∫—É notes –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã *_prompt.md –≤ —Å–ª–æ–≤–∞—Ä—å.
        """
        notes_path = os.path.join(self.project_path, "notes")
        if os.path.isdir(notes_path):
            for file_name in os.listdir(notes_path):
                if file_name.endswith("_prompt.md"):
                    file_path = os.path.join(notes_path, file_name)
                    self.prompts[file_name] = file_path

    def setup_ui(self):
        """
        –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤, –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è, –º–µ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
        """
        self.root.title("–°–±–æ—Ä –∫–æ–¥–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏")
        self.root.geometry("800x650")  # –£–≤–µ–ª–∏—á–∏–ª–∏ –≤—ã—Å–æ—Ç—É –∏ —à–∏—Ä–∏–Ω—É

        # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—Ä–µ–π–º
        main_frame = ttk.Frame(self.root)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        # –î–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤
        self.tree = ttk.Treeview(main_frame)
        self.tree.heading("#0", text="–§–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏", anchor=tk.W)
        self.tree.column("#0", width=600)

        # –ü—Ä–æ–∫—Ä—É—Ç–∫–∞
        scrollbar = ttk.Scrollbar(
            main_frame, orient=tk.VERTICAL, command=self.tree.yview
        )
        self.tree.configure(yscroll=scrollbar.set)

        self.tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        # –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å
        bottom_frame = ttk.Frame(self.root)
        bottom_frame.pack(fill=tk.X, padx=10, pady=5)

        # –°–ª–µ–≤–∞: –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–ø—Ç–æ–≤
        left_frame = ttk.Frame(bottom_frame)
        left_frame.pack(side=tk.LEFT, padx=(0, 20))

        ttk.Label(left_frame, text="üìù –ü—Ä–æ–º–ø—Ç:").pack(anchor=tk.W)
        self.prompt_var = tk.StringVar()

        # –°–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π: "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞" + –∏–º–µ–Ω–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
        prompt_options = ["–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞"] + list(self.prompts.keys())
        self.prompt_combo = ttk.Combobox(
            left_frame,
            textvariable=self.prompt_var,
            values=prompt_options,
            state="readonly",
            width=25,
        )
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞" –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.prompt_combo.set("–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞")

        # –ï—Å–ª–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ –Ω–µ—Ç, –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞"
        if not self.prompts:
            self.prompt_combo.config(state="disabled")
        self.prompt_combo.pack(pady=2)

        # –¶–µ–Ω—Ç—Ä: —á–µ–∫–±–æ–∫—Å "–î–µ—Ä–µ–≤–æ" –∏ –∫–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å"
        center_frame = ttk.Frame(bottom_frame)
        center_frame.pack(side=tk.LEFT, padx=20)

        self.tree_var = tk.BooleanVar()
        self.tree_checkbox = ttk.Checkbutton(
            center_frame, text="–î–µ—Ä–µ–≤–æ", variable=self.tree_var
        )
        self.tree_checkbox.pack(pady=2)

        self.refresh_btn = ttk.Button(
            center_frame, text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–µ—Ä–µ–≤–æ", command=self.refresh_tree
        )
        self.refresh_btn.pack(pady=5)

        # –°–ø—Ä–∞–≤–∞: –∫–Ω–æ–ø–∫–∏ "–°–±—Ä–æ—Å–∏—Ç—å" –∏ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"
        right_frame = ttk.Frame(bottom_frame)
        right_frame.pack(side=tk.RIGHT, padx=(20, 0))

        self.clear_btn = ttk.Button(
            right_frame, text="üßπ –°–±—Ä–æ—Å–∏—Ç—å —á–µ–∫–±–æ–∫—Å—ã", command=self.clear_all_selections
        )
        self.clear_btn.pack(pady=3)

        self.copy_btn = ttk.Button(
            right_frame,
            text="üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞",
            command=self.copy_selected_to_clipboard,
        )
        self.copy_btn.pack(pady=3)

        # –ú–µ—Ç–∫–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞)
        self.status_label = tk.Label(self.root, text="", fg="green", font=("Arial", 10))
        self.status_label.pack(pady=5)

        # –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ä–µ–≤–æ
        self.populate_tree()

        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–π –∫–ª–∏–∫ –∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—é –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        self.tree.bind("<ButtonRelease-1>", self.on_item_click)
        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ—Ä–µ–≤–∞ –ø–∞–ø–∫–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        self.tree.bind("<Double-Button-1>", self.on_item_double_click)

        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –í –ö–û–ù–¶–ï, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∏—Å—å –¥—Ä—É–≥–∏–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É Ctrl+C –∫ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        self.root.bind_all(
            "<Control-c>", lambda event: self.copy_selected_to_clipboard()
        )
        # –¢–∞–∫–∂–µ –ª–æ–≤–∏–º Ctrl + —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏—à–∞ C/–° (keycode 67 –≤ —Ä—É—Å—Å–∫–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ)
        self.root.bind_all("<Control-Key>", self.on_ctrl_key_press)
        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏—à—É T (–∏–ª–∏ –ï, –Ω–∞ —Ç–æ–π –∂–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏—à–µ) –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ "–î–µ—Ä–µ–≤–æ"
        self.root.bind_all("<Key>", self.on_key_press)

    def on_ctrl_key_press(self, event):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫—É—é —Ä–∞—Å–∫–ª–∞–¥–∫—É
        if event.keysym == "c":
            self.copy_selected_to_clipboard()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä—É—Å—Å–∫—É—é —Ä–∞—Å–∫–ª–∞–¥–∫—É (–µ—Å–ª–∏ keycode == 67 ‚Äî —ç—Ç–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏—à–∞ C/–°)
        elif event.keycode == 67:
            self.copy_selected_to_clipboard()

    def on_key_press(self, event):
        """
        –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à.
        –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —á–µ–∫–±–æ–∫—Å "–î–µ—Ä–µ–≤–æ", –µ—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ T/t –∏–ª–∏ –ï/–µ.
        """
        char = event.char.lower()
        if char == "t" or char == "–µ":
            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞
            current_value = self.tree_var.get()
            self.tree_var.set(not current_value)

    def populate_tree(self):
        """
        –ó–∞–ø–æ–ª–Ω—è–µ—Ç –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–∞–º–∏ –∏ –ø–∞–ø–∫–∞–º–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞.
        """
        root_node = self.tree.insert(
            "", "end", text=f"{os.path.basename(self.project_path)}", open=True
        )
        self.tree_items[root_node] = {"path": self.project_path, "type": "dir"}
        self._add_directory_contents(root_node, self.project_path)

    def refresh_tree(self):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤, —Å–æ—Ö—Ä–∞–Ω—è—è –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Å—Ç–∞–ª–∏—Å—å."""
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        selected_paths = {
            self.tree_items[item_id]["path"] for item_id in self.selected_files
        }

        # –û—á–∏—â–∞–µ–º –¥–µ—Ä–µ–≤–æ
        self.tree.delete(*self.tree.get_children())
        self.tree_items.clear()
        self.selected_files.clear()

        # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –¥–µ—Ä–µ–≤–æ
        self.populate_tree()

        # –ü–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–¥–µ–ª—è–µ–º —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–ª–∏—Å—å
        for item_id, data in self.tree_items.items():
            if data["type"] == "file" and data["path"] in selected_paths:
                self.selected_files.add(item_id)
                self.tree.item(item_id, text=f"{self.tree.item(item_id, 'text')} [‚úì]")

        self.show_status("–î–µ—Ä–µ–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.", "green")

    def copy_single_dir_tree(self, dir_path):
        """
        –ö–æ–ø–∏—Ä—É–µ—Ç –¥–µ—Ä–µ–≤–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.
        """
        dir_name = os.path.basename(dir_path) + "/"
        tree_output = f"{dir_name}\n{get_tree_structure(dir_path).rstrip()}\n"
        self.root.clipboard_clear()
        self.root.clipboard_append(tree_output)
        self.root.update()
        self.show_status(f"–î–µ—Ä–µ–≤–æ –ø–∞–ø–∫–∏ '{dir_name}' —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä.", "green")

    def _add_directory_contents(self, parent, path):
        """
        –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤ –¥–µ—Ä–µ–≤–æ.

        :param parent: —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –≤ –¥–µ—Ä–µ–≤–µ
        :param path: –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        """
        try:
            for entry in os.listdir(path):
                entry_path = os.path.join(path, entry)

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª/–ø–∞–ø–∫—É
                if should_ignore(entry, os.path.isdir(entry_path)):
                    continue

                if os.path.isdir(entry_path):
                    node = self.tree.insert(
                        parent, "end", text=f"[DIR] {entry}", open=False
                    )
                    self.tree_items[node] = {"path": entry_path, "type": "dir"}
                    # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                    self._add_directory_contents(node, entry_path)
                else:
                    node = self.tree.insert(parent, "end", text=f"[FILE] {entry}")
                    self.tree_items[node] = {"path": entry_path, "type": "file"}

        except PermissionError:
            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–∞–ø–∫–∏, –∫ –∫–æ—Ç–æ—Ä—ã–º –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞

    def on_item_click(self, event):
        """
        –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω–∞—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –¥–µ—Ä–µ–≤–∞.
        –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ —Ñ–∞–π–ª—É ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤—ã–±–æ—Ä.
        –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –ø–∞–ø–∫–µ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç/—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç.
        """
        item_id = self.tree.identify_row(event.y)
        if item_id not in self.tree_items:
            return

        item = self.tree_items[item_id]

        if item["type"] == "file":
            # –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤ (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏)
            if item_id in self.selected_files:
                self.selected_files.remove(item_id)
                self.tree.item(
                    item_id, text=self.tree.item(item_id, "text").replace(" [‚úì]", "")
                )
            else:
                self.selected_files.add(item_id)
                self.tree.item(item_id, text=f"{self.tree.item(item_id, 'text')} [‚úì]")

    def on_item_double_click(self, event):
        """
        –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –¥–µ—Ä–µ–≤–∞.
        –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –ø–∞–ø–∫–µ ‚Äî –∫–æ–ø–∏—Ä—É–µ—Ç –¥–µ—Ä–µ–≤–æ —ç—Ç–æ–π –ø–∞–ø–∫–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.
        """
        item_id = self.tree.identify_row(event.y)
        if item_id not in self.tree_items:
            return

        item = self.tree_items[item_id]

        if item["type"] == "dir":
            # –ö–æ–ø–∏—Ä—É–µ–º –¥–µ—Ä–µ–≤–æ –ø–∞–ø–∫–∏
            self.copy_single_dir_tree(item["path"])

    def clear_all_selections(self):
        """
        –°–Ω–∏–º–∞–µ—Ç –≤—ã–±–æ—Ä —Å–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤.
        """
        for item_id in self.selected_files.copy():
            # –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É —Å —Ñ–∞–π–ª–∞ –≤ –¥–µ—Ä–µ–≤–µ
            self.tree.item(
                item_id, text=self.tree.item(item_id, "text").replace(" [‚úì]", "")
            )
        self.selected_files.clear()
        self.show_status("–í—Å–µ –≥–∞–ª–æ—á–∫–∏ —Å–Ω—è—Ç—ã.", "green")

    def copy_selected_to_clipboard(self):
        """
        –°–æ–±–∏—Ä–∞–µ—Ç: –ø—Ä–æ–º–ø—Ç (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω), –¥–µ—Ä–µ–≤–æ (–µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å –≤–∫–ª—é—á–µ–Ω), —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã).
        –ö–æ–ø–∏—Ä—É–µ—Ç –≤—Å—ë –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.
        """
        output_parts = []

        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∏ –Ω–µ —Ä–∞–≤–µ–Ω "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞"
        prompt_name = self.prompt_var.get()
        if prompt_name and prompt_name != "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞":
            prompt_path = self.prompts.get(prompt_name)
            if prompt_path:
                try:
                    with open(prompt_path, encoding="utf-8") as f:
                        prompt_content = f.read()
                    output_parts.append(
                        f"=== –ü—Ä–æ–º–ø—Ç: {prompt_name} ===\n{prompt_content}\n"
                    )
                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ {prompt_path}: {e}")

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ä–µ–≤–æ, –µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å –≤–∫–ª—é—á–µ–Ω
        if self.tree_var.get():
            root_name = os.path.basename(self.project_path) + "/"
            tree_output = f"=== –î–µ—Ä–µ–≤–æ –ø—Ä–æ–µ–∫—Ç–∞ ===\n{root_name}\n{get_tree_structure(self.project_path).rstrip()}\n"
            output_parts.append(tree_output)

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
        if self.selected_files:
            files_content = []
            for item_id in self.selected_files:
                data = self.tree_items[item_id]
                try:
                    with open(data["path"], encoding="utf-8") as f:
                        content = f.read()
                    files_content.append(f"=== {data['path']} ===\n{content}\n")
                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ {data['path']}: {e}")
            output_parts.append("\n".join(files_content))

        if not output_parts:
            self.show_status("–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.", "red")
            return

        full_output = "\n".join(output_parts)

        # –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        self.root.clipboard_clear()
        self.root.clipboard_append(full_output)
        self.root.update()

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        parts_info = []
        if prompt_name and prompt_name != "–ë–µ–∑ –ø—Ä–æ–º–ø—Ç–∞":
            parts_info.append("–ø—Ä–æ–º–ø—Ç")
        if self.tree_var.get():
            parts_info.append("–¥–µ—Ä–µ–≤–æ")
        if self.selected_files:
            parts_info.append(f"{len(self.selected_files)} —Ñ–∞–π–ª(–æ–≤)")

        if parts_info:
            self.show_status(f"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: {', '.join(parts_info)}.", "green")

    def show_status(self, message, color):
        """
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã.
        """
        self.status_label.config(text=message, fg=color)
        self.root.after(3000, self.clear_status)  # –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –æ—á–∏—Å—Ç–∏—Ç—å

    def clear_status(self):
        """
        –û—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
        """
        self.status_label.config(text="")


if __name__ == "__main__":
    root = tk.Tk()
    app = CodeCollectorApp(root)
    root.mainloop()
